<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>GCode Font Creator</title><style>:root[data-theme="light"]{--bg-color:#ffffff;--text-color:#333333;--border-color:#cccccc;--panel-bg:#f5f5f5;--button-bg:#e0e0e0;--button-hover:#d0d0d0;--button-active:#0066cc;--canvas-bg:#fafafa;--rapid-color:#999999;--cut-color:#0066cc;--grid-color:#e0e0e0;--gcode-comment:#808080;--gcode-g-code:#0066aa;--gcode-m-code:#8b3e8e;--gcode-t-code:#b5640f;--gcode-s-code:#008577;--gcode-f-code:#a65e3e;--gcode-coordinate:#6a8759;--gcode-system:#cc7000;--gcode-x-axis:#1976d2;--gcode-y-axis:#388e3c;--gcode-z-axis:#7b1fa2;}:root[data-theme="dark"]{--bg-color:#1e1e1e;--text-color:#e0e0e0;--border-color:#444444;--panel-bg:#2d2d2d;--button-bg:#3d3d3d;--button-hover:#4d4d4d;--button-active:#0066cc;--canvas-bg:#252525;--rapid-color:#ff9933;--cut-color:#00ccff;--grid-color:#3a3a3a;--gcode-comment:#999999;--gcode-g-code:#4fc3ff;--gcode-m-code:#e1aaff;--gcode-t-code:#ffd180;--gcode-s-code:#80cbc4;--gcode-f-code:#ffab91;--gcode-coordinate:#8fd6a3;--gcode-system:#ffb84d;--gcode-x-axis:#42a5f5;--gcode-y-axis:#66bb6a;--gcode-z-axis:#ba68c8;}:root[data-theme="dark"] *::-webkit-scrollbar{width:16px;height:16px;}:root[data-theme="dark"] *::-webkit-scrollbar-track{background:#2a2a2a;}:root[data-theme="dark"] *::-webkit-scrollbar-thumb{background:#555555;border-radius:8px;border:3px solid #2a2a2a;}:root[data-theme="dark"] *::-webkit-scrollbar-thumb:hover{background:#666666;}:root[data-theme="dark"] *{scrollbar-width:auto;scrollbar-color:#555555 #2a2a2a;}*{margin:0;padding:0;box-sizing:border-box;}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,sans-serif;background-color:var(--bg-color);color:var(--text-color);overflow:hidden;height:100vh;}.container{display:grid;grid-template-columns:400px 1fr 360px;grid-template-rows:60px 1fr 40px;height:100vh;gap:0;}header{grid-column:1 / -1;grid-row:1;background-color:var(--panel-bg);border-bottom:1px solid var(--border-color);display:flex;align-items:center;justify-content:space-between;padding:0 20px;}header h1{font-size:1.5rem;font-weight:600;}.header-controls{display:flex;gap:10px;align-items:center;}.header-controls a{text-decoration:none;color:var(--text-color);padding:8px 16px;background-color:var(--button-bg);border:1px solid var(--border-color);border-radius:4px;font-size:0.9rem;transition:background-color 0.2s;display:inline-flex;align-items:center;justify-content:center;box-sizing:border-box;line-height:1;min-height:38px;}.header-controls a:hover{background-color:var(--button-hover);}button{background-color:var(--button-bg);color:var(--text-color);border:1px solid var(--border-color);padding:8px 16px;border-radius:4px;cursor:pointer;font-size:14px;transition:background-color 0.2s;}button:hover{background-color:var(--button-hover);}button:active{transform:translateY(1px);}button:disabled{opacity:0.5;cursor:not-allowed;}.canvas-container{position:relative;background-color:var(--canvas-bg);overflow:hidden;grid-column:2;grid-row:2;}.canvas-overlay-controls{position:absolute;top:10px;right:10px;display:flex;gap:10px;z-index:10;}.canvas-overlay-controls button{padding:8px 16px;background-color:rgba(0,0,0,0.7);color:white;border:1px solid rgba(255,255,255,0.3);border-radius:4px;cursor:pointer;font-size:14px;backdrop-filter:blur(5px);}.canvas-overlay-controls button:hover{background-color:rgba(0,0,0,0.85);}.canvas-overlay-controls button:disabled{opacity:0.5;cursor:not-allowed;}canvas{display:block;width:100%;height:100%;cursor:grab;}canvas:active{cursor:grabbing;}#canvas2d,#canvas3d{position:absolute;top:0;left:0;}#canvas3d-overlay{position:absolute;top:0;left:0;pointer-events:none;}.hidden{display:none !important;}.sidebar{background-color:var(--panel-bg);border-left:1px solid var(--border-color);overflow-y:auto;padding:20px;grid-column:3;grid-row:2;}.left-sidebar{background-color:var(--panel-bg);border-right:1px solid var(--border-color);padding:0;display:flex;flex-direction:column;overflow:hidden;grid-column:1;grid-row:2;min-height:0;height:100%;}#gcode-panel{display:flex !important;flex:1;flex-direction:column;overflow:hidden;min-height:0;height:100%;padding:10px;margin:20px;}#gcode-panel h3{margin:10px 0 10px 0;flex-shrink:0;}#gcode-panel{display:flex !important;flex:1;flex-direction:column;overflow:hidden;min-height:0;}#gcode-container{flex:1;overflow-y:auto;overflow-x:auto;background-color:var(--canvas-bg);border:none;font-family:'Consolas','Monaco',monospace;font-size:11px;line-height:17px;min-height:0;padding-bottom:10px;margin-bottom:5px;}#gcode-content{display:flex;}.gcode-line-numbers{color:var(--text-muted);text-align:right;padding:4px 8px 4px 4px;user-select:none;border-right:1px solid var(--border-color);min-width:30px;}.gcode-code{flex:1;padding:4px;white-space:pre;}.gcode-line{cursor:pointer;}.gcode-line:hover{background-color:rgba(255,255,255,0.05) !important;}.gcode-line.highlight{background-color:rgba(255,193,7,0.3) !important;}.gcode-line-numbers .gcode-line.highlight{border-left:3px solid rgba(255,193,7,0.8) !important;padding-left:2px !important;}.gcode-comment{color:var(--gcode-comment);}.gcode-g-code{color:var(--gcode-g-code);font-weight:bold;}.gcode-m-code{color:var(--gcode-m-code);font-weight:bold;}.gcode-t-code{color:var(--gcode-t-code);font-weight:bold;}.gcode-s-code{color:var(--gcode-s-code);}.gcode-f-code{color:var(--gcode-f-code);}.gcode-coordinate{color:var(--gcode-coordinate);}.gcode-system{color:var(--gcode-system);font-weight:bold;}.gcode-x-axis{color:var(--gcode-x-axis);font-weight:500;}.gcode-y-axis{color:var(--gcode-y-axis);font-weight:500;}.gcode-z-axis{color:var(--gcode-z-axis);font-weight:500;}.gcode-hidden{display:none !important;}.panel{background-color:var(--bg-color);border:1px solid var(--border-color);border-radius:4px;padding:15px;margin-bottom:15px;}.panel h3{font-size:1rem;margin-bottom:10px;font-weight:600;}.file-upload-zone{border:2px dashed var(--border-color);border-radius:4px;padding:30px;text-align:center;cursor:pointer;transition:border-color 0.2s;}.file-upload-zone:hover{border-color:var(--cut-color);}.file-upload-zone.drag-over{border-color:var(--cut-color);background-color:var(--canvas-bg);}input[type="file"]{display:none;}select{width:100%;padding:8px;background-color:var(--button-bg);color:var(--text-color);border:1px solid var(--border-color);border-radius:4px;font-size:14px;cursor:pointer;margin-top:10px;}input[type="range"]{width:100%;margin-top:10px;accent-color:var(--cut-color);}input[type="checkbox"]{accent-color:var(--cut-color);}.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;}.stat-item{background-color:var(--panel-bg);padding:8px;border-radius:4px;}.stat-label{font-size:11px;opacity:0.7;text-transform:uppercase;}.stat-value{font-size:16px;font-weight:600;margin-top:2px;}.progress-bar{width:100%;height:4px;background-color:var(--border-color);border-radius:2px;overflow:hidden;margin-top:10px;position:relative;}.progress-bar.indeterminate .progress-fill{width:30% !important;animation:indeterminate 1.5s ease-in-out infinite;}@keyframes indeterminate{0%{transform:translateX(-100%);}50%{transform:translateX(350%);}100%{transform:translateX(-100%);}}.progress-fill{height:100%;background-color:var(--cut-color);width:0%;transition:width 0.3s;}.animation-controls{margin-top:15px;}.controls-row{display:flex;gap:5px;margin-bottom:10px;}.controls-row button{flex:1;padding:6px;font-size:12px;}.layer-controls{margin-top:10px;}.dual-range-slider{position:relative;height:20px;margin:10px 0;display:flex;align-items:center;}.dual-range-slider::before{content:'';position:absolute;left:0;right:0;top:50%;transform:translateY(-50%);height:8px;background:var(--border-color);border-radius:4px;pointer-events:none;}.dual-range-slider .range-highlight{position:absolute;top:50%;transform:translateY(-50%);height:8px;background:var(--cut-color);border-radius:4px;pointer-events:none;z-index:1;opacity:0.8;}.dual-range-slider input[type="range"]{position:absolute;width:100%;height:20px;background:transparent;pointer-events:none;-webkit-appearance:none;appearance:none;margin:0;}.dual-range-slider input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:18px;height:18px;border-radius:50%;background:var(--cut-color);cursor:pointer;pointer-events:all;border:2px solid var(--border-color);box-shadow:0 2px 4px rgba(0,0,0,0.2);position:relative;z-index:2;margin-top:1px;}.dual-range-slider input[type="range"]::-moz-range-thumb{width:18px;height:18px;border-radius:50%;background:var(--cut-color);cursor:pointer;pointer-events:all;border:2px solid var(--border-color);box-shadow:0 2px 4px rgba(0,0,0,0.2);position:relative;z-index:2;}.dual-range-slider input[type="range"]::-webkit-slider-runnable-track{width:100%;height:20px;background:transparent;}.dual-range-slider input[type="range"]::-moz-range-track{width:100%;height:20px;background:transparent;border:none;}.dual-range-slider .range-max{z-index:1;}.layer-inputs{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;}.layer-inputs > div{display:flex;flex-direction:column;}.layer-inputs input{width:100%;padding:6px;background-color:var(--button-bg);color:var(--text-color);border:1px solid var(--border-color);border-radius:4px;font-size:14px;box-sizing:border-box;}footer{grid-column:1 / -1;grid-row:3;background-color:var(--panel-bg);border-top:1px solid var(--border-color);display:flex;align-items:center;justify-content:space-between;padding:0 20px;font-size:12px;}.coordinate-display{font-family:'Courier New',monospace;}.privacy-notice{font-size:11px;opacity:0.7;margin-top:15px;padding-top:15px;border-top:1px solid var(--border-color);text-align:center;}.mobile-tabs{display:none;background-color:var(--panel-bg);border-bottom:1px solid var(--border-color);overflow-x:auto;overflow-y:hidden;}.mobile-tabs-nav{display:flex;gap:0;min-width:100%;}.mobile-tab-button{flex:1;padding:12px 16px;background:none;border:none;border-bottom:3px solid transparent;cursor:pointer;font-size:14px;color:var(--text-color);transition:all 0.2s;white-space:nowrap;}.mobile-tab-button:hover{background-color:rgba(0,0,0,0.05);}.mobile-tab-button.active{border-bottom-color:#0066aa;font-weight:bold;}.mobile-tab-content{display:none;}.mobile-tab-content.active{display:block;}@media (min-width:969px){.mobile-tab-content{display:block !important;}}@media (max-width:1200px){.container{grid-template-columns:300px 1fr 300px;}}@media (max-width:968px){.container{grid-template-columns:1fr;grid-template-rows:auto 1fr;}body{overflow:hidden;height:100vh;height:100dvh;}header{position:absolute;width:0;height:0;overflow:hidden;visibility:hidden;}.mobile-tabs{display:block;grid-row:1;}.canvas-overlay-controls{top:5px;right:5px;gap:5px;}.canvas-overlay-controls button{padding:6px 10px;font-size:12px;}.header-controls button{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}#btn-play::before{content:'‚ñ∂Ô∏è ';}#btn-step-back::before{content:'‚èÆÔ∏è ';}#btn-step-forward::before{content:'‚è≠Ô∏è ';}#btn-reset-animation::before{content:'‚èπÔ∏è ';}.file-upload-zone::before{content:'üìÅ\A';white-space:pre;font-size:2em;display:block;margin-bottom:10px;}.left-sidebar{grid-row:2;grid-column:1;border-right:none;border-top:1px solid var(--border-color);overflow:hidden;padding:0;}#gcode-panel{display:flex !important;height:100%;flex-direction:column;}.canvas-container{grid-row:2;grid-column:1;width:100%;height:100%;position:relative;min-height:300px;}canvas{position:absolute;top:0;left:0;width:100% !important;height:100% !important;}.sidebar{grid-row:2;grid-column:1;border-left:none;border-top:1px solid var(--border-color);max-height:none;overflow-y:auto;overflow-y:auto;padding:10px;}.panel{margin-bottom:10px;padding:10px;}.stats-grid{grid-template-columns:repeat(2,1fr);}.slider-container{font-size:12px;}input[type="range"]{height:30px;}button{min-height:44px;font-size:14px;}footer{position:absolute;width:0;height:0;overflow:hidden;visibility:hidden;}}@media (max-width:480px){.header-controls{flex-wrap:wrap;}.header-controls button{flex:1 1 45%;margin:2px;}.stats-grid{grid-template-columns:1fr;}.panel h3{font-size:0.9rem;}.mobile-tab-button{padding:0px 12px;}#settings-tab .panel,#gcode-tab .panel,#gcode-panel{padding:6px;margin-bottom:6px;}#settings-tab .panel h3,#gcode-tab .panel h3,#gcode-panel h3{margin-bottom:4px;}#settings-tab .control-group,#gcode-tab .control-group{margin-bottom:6px;}#settings-tab .slider-container,#gcode-tab .slider-container{margin:4px 0;}#settings-tab label,#gcode-tab label{margin-bottom:2px;}#settings-tab input,#settings-tab select,#settings-tab button,#gcode-tab input,#gcode-tab select,#gcode-tab button{padding:6px 8px;}.container{padding:0 !important;}header{padding:0 4px;}.sidebar{padding:2px;}#gcode-panel{margin:6px;padding:4px;}#gcode-panel h3{margin:4px 0;}}@media (hover:none) and (pointer:coarse){button,input[type="checkbox"],input[type="color"]{min-height:44px;min-width:44px;}.slider-container input[type="range"]{height:44px;}.gcode-line{line-height:24px;height:24px;padding:2px 0;}}</style><style> body{height:100vh;height:100dvh;display:flex;flex-direction:column;overflow:hidden;}header{padding:15px;background-color:var(--panel-bg);border-bottom:1px solid var(--border-color);display:flex;justify-content:space-between;align-items:center;flex-shrink:0;}header h1{font-size:20px;font-weight:600;margin:0;}input[type="text"],input[type="number"],textarea,select{width:100%;padding:8px 12px;background-color:var(--button-bg);color:var(--text-color);border:1px solid var(--border-color);border-radius:4px;font-size:14px;font-family:inherit;box-sizing:border-box;transition:border-color 0.2s;}input[type="text"]:focus,input[type="number"]:focus,textarea:focus,select:focus{outline:none;border-color:var(--button-active);}textarea{resize:vertical;font-family:inherit;}.input-group{margin-bottom:15px;}.input-group label{display:block;font-size:13px;font-weight:500;margin-bottom:5px;color:var(--text-color);}button{background-color:var(--button-bg);color:var(--text-color);border:1px solid var(--border-color);padding:8px 16px;border-radius:4px;cursor:pointer;font-size:14px;transition:background-color 0.2s;}button:hover{background-color:var(--button-hover);}button:active{transform:translateY(1px);}button.primary{background-color:var(--button-active);color:white;border-color:var(--button-active);}button.primary:hover{opacity:0.9;}.status{flex:1;font-size:13px;opacity:0.7;}.tab-nav{display:flex;background-color:var(--panel-bg);border-bottom:1px solid var(--border-color);padding:0 15px;gap:5px;}.tab-button{padding:12px 24px;background:none;border:none;border-bottom:3px solid transparent;color:var(--text-color);cursor:pointer;font-size:14px;font-weight:500;transition:all 0.2s;opacity:0.7;}.tab-button:hover{opacity:1;background-color:var(--button-hover);}.tab-button.active{opacity:1;border-bottom-color:var(--button-active);}.tab-content{display:none;flex:1;overflow:hidden;flex-direction:column;}.tab-content.active{display:flex;}.main-container{display:flex;flex:1;overflow:hidden;position:relative;}.panel-toggle{position:absolute;top:10px;left:10px;z-index:1000;width:40px;height:40px;padding:0;font-size:20px;background-color:var(--button-bg);border:1px solid var(--border-color);border-radius:4px;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(0,0,0,0.15);}.panel-toggle:hover{background-color:var(--button-hover);}.left-panel{width:300px;background-color:var(--panel-bg);border-right:1px solid var(--border-color);overflow-y:auto;padding:15px;padding-top:70px;flex-shrink:0;transition:width 0.3s ease,padding 0.3s ease,opacity 0.3s ease;}.left-panel.collapsed{width:0;padding:0;opacity:0;overflow:hidden;border-right:none;}@media (max-width:768px){.left-panel{position:absolute;top:0;left:0;height:100%;z-index:999;padding-top:70px;}.left-panel .section:first-child{margin-top:0;}}.center-panel{flex:1;display:flex;flex-direction:column;overflow:hidden;}.canvas-container{flex:1;display:flex;align-items:center;justify-content:center;background-color:var(--canvas-bg);position:relative;overflow:hidden;}#drawing-canvas{border:2px solid var(--border-color);cursor:crosshair;touch-action:none;background-color:white;display:block;width:600px !important;height:600px !important;flex-shrink:0;}.toolbar{padding:15px;background-color:var(--panel-bg);border-top:1px solid var(--border-color);display:flex;gap:10px;flex-wrap:wrap;align-items:center;}.section{margin-bottom:20px;}.section h3{font-size:14px;font-weight:600;margin-bottom:10px;color:var(--text-color);}.collapsible-header{cursor:pointer;user-select:none;display:flex;justify-content:space-between;align-items:center;padding:8px 10px;margin:-5px -5px 10px -5px;border-radius:4px;transition:background-color 0.2s,border-color 0.2s;background-color:var(--button-bg);border:1px solid var(--border-color);}.collapsible-header:hover{background-color:var(--button-hover);border-color:var(--text-color);}.collapse-icon{font-size:12px;transition:transform 0.2s;}.collapsible-header.collapsed .collapse-icon{transform:rotate(-90deg);}.collapsible-content{max-height:2000px;overflow-y:auto;overflow-x:hidden;transition:max-height 0.3s ease-out,opacity 0.3s ease-out;opacity:1;}.collapsible-content.collapsed{max-height:0;opacity:0;overflow:hidden;}.char-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(40px,1fr));gap:5px;margin-top:10px;}.char-button{padding:8px;background-color:var(--button-bg);border:1px solid var(--border-color);border-radius:4px;cursor:pointer;font-size:16px;text-align:center;transition:all 0.2s;}.char-button:hover{background-color:var(--button-hover);}.char-button.active{background-color:var(--button-active);color:white;border-color:var(--button-active);}.char-button.defined{font-weight:bold;border-width:2px;}#gcode-preview .container{display:flex;height:100%;width:100%;gap:0;}#gcode-preview .left-sidebar{width:400px;flex-shrink:0;display:block !important;order:1;}#gcode-preview .canvas-container{flex:1;position:relative;background-color:var(--canvas-bg);overflow:hidden;order:2;min-width:0;}#gcode-preview .sidebar{width:360px;flex-shrink:0;order:3;}.tooltip-label{position:relative;cursor:help;}.tooltip-label .tooltip-icon{display:inline-block;margin-left:4px;opacity:0.6;}.tooltip-label .tooltip-text{visibility:hidden;opacity:0;position:absolute;z-index:1000;bottom:125%;left:50%;transform:translateX(-50%);background-color:#333333;color:#ffffff;text-align:left;padding:8px 12px;border-radius:6px;font-size:12px;line-height:1.4;white-space:normal;width:250px;box-shadow:0 2px 8px rgba(0,0,0,0.2);transition:opacity 0.2s,visibility 0.2s;pointer-events:none;}:root[data-theme="dark"] .tooltip-label .tooltip-text{background-color:#f5f5f5;color:#333333;}.tooltip-label .tooltip-text::after{content:"";position:absolute;top:100%;left:50%;transform:translateX(-50%);border-width:5px;border-style:solid;border-color:#333333 transparent transparent transparent;}:root[data-theme="dark"] .tooltip-label .tooltip-text::after{border-color:#f5f5f5 transparent transparent transparent;}.tooltip-label:hover .tooltip-text{visibility:visible;opacity:1;}</style></head><body><header><h1>‚úçÔ∏è GCode Font Creator</h1><div class="header-controls"><button id="theme-toggle" style="padding: 8px 16px;">üåì Theme</button></div></header><div class="tab-nav"><button class="tab-button active" data-tab="font-creator">‚úèÔ∏è Font Creator</button><button class="tab-button" data-tab="text-to-gcode">üìù Text To GCode</button><button class="tab-button" data-tab="gcode-preview">üé¨ GCode Preview</button></div><div class="tab-content active" id="font-creator"><div class="font-toolbar" style="display: flex; gap: 10px; padding: 6px 15px; background-color: var(--panel-bg); border-top: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color); align-items: center; flex-wrap: wrap;"><label style="font-weight: 500;">Font:</label><select id="font-selector-editor" style="padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-color); color: var(--text-color); width: 250px; margin-top: 0px;"><option value="">Select a font...</option></select><button id="new-font" style="padding: 8px 16px; white-space: nowrap;">‚ú® New</button><button id="save-font" class="primary" style="padding: 8px 16px; white-space: nowrap;">üíæ Save</button><button id="preview-font" style="padding: 8px 16px; white-space: nowrap;">üëÅÔ∏è Preview</button><button id="delete-font" style="padding: 8px 16px; white-space: nowrap; color: #d32f2f;">üóëÔ∏è Delete</button><button id="import-svg-font-btn" style="padding: 8px 16px; white-space: nowrap;">üì• Import SVG Font</button><button id="export-svg-font" style="padding: 8px 16px; white-space: nowrap;">üì§ Export SVG Font</button><input type="file" id="import-svg-font" accept=".svg" style="display: none;" /></div><div class="main-container"><button id="toggle-left-panel" class="panel-toggle" aria-label="Toggle left panel">‚ò∞</button><aside class="left-panel"><div class="section"><h3 class="collapsible-header collapsed" id="font-settings-header">Font Settings <span class="collapse-icon">‚ñº</span></h3><div class="collapsible-content collapsed" id="font-settings-content"><div class="input-group"><label>Font Name</label><input type="text" id="font-name" value="Custom Font" /></div><div class="input-group"><label class="tooltip-label"> Simplification Tolerance <span class="tooltip-icon">‚ÑπÔ∏è</span><span class="tooltip-text">Maximum distance (in pixels) a point can be from the simplified line. Lower values keep more detail, higher values create smoother curves with fewer points.</span></label><input type="number" id="simplify-tolerance" value="2" step="0.5" min="0.5" /></div><div class="input-group"><label class="tooltip-label"> Arc Tolerance (mm) <span class="tooltip-icon">‚ÑπÔ∏è</span><span class="tooltip-text">Maximum deviation (in mm) allowed when converting curves to G-code arcs. Smaller values create more accurate arcs but may generate more arc commands.</span></label><input type="number" id="arc-tolerance" value="0.1" step="0.01" min="0.01" /></div><hr style="margin: 15px 0; border: none; border-top: 1px solid var(--border-color);"><h4 style="margin: 10px 0 10px 0; font-size: 14px;">Guide Line Positions (SVG Units)</h4><div class="input-group"><label class="tooltip-label"> Ascent <span class="tooltip-icon">‚ÑπÔ∏è</span><span class="tooltip-text">Top of tall letters like 'h', 'k', 'l' (SVG font units, typically ~800 for 1000 units-per-em).</span></label><input type="number" id="ascent-pos" value="800" step="10" /></div><div class="input-group"><label class="tooltip-label"> Cap Height <span class="tooltip-icon">‚ÑπÔ∏è</span><span class="tooltip-text">Top of capital letters (SVG font units, typically ~700 for 1000 units-per-em).</span></label><input type="number" id="cap-height-pos" value="700" step="10" /></div><div class="input-group"><label class="tooltip-label"> X-Height <span class="tooltip-icon">‚ÑπÔ∏è</span><span class="tooltip-text">Top of lowercase letters like 'x' (SVG font units, typically ~500 for 1000 units-per-em).</span></label><input type="number" id="x-height-pos" value="500" step="10" /></div><div class="input-group"><label class="tooltip-label"> Baseline <span class="tooltip-icon">‚ÑπÔ∏è</span><span class="tooltip-text">Where letters sit (SVG font units, always 0 by definition in SVG fonts).</span></label><input type="number" id="baseline-pos" value="0" step="10" /></div><div class="input-group"><label class="tooltip-label"> Descent <span class="tooltip-icon">‚ÑπÔ∏è</span><span class="tooltip-text">Bottom of descenders like 'g', 'y' (SVG font units, typically -200 for 1000 units-per-em).</span></label><input type="number" id="descent-pos" value="-200" step="10" /></div><button id="reset-guides" style="width: 100%; margin-top: 5px;">‚Ü∫ Reset to Defaults</button></div></div><div class="section"><h3 class="collapsible-header collapsed" id="char-set-header">Character Set <span class="collapse-icon">‚ñº</span></h3><div class="collapsible-content collapsed"><div style="display: flex; gap: 5px; margin-bottom: 10px;"><input type="text" id="custom-char-input" placeholder="Enter character(s)" maxlength="10" style="flex: 1; padding: 5px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-color); color: var(--text-color);" /><button id="add-custom-char" style="white-space: nowrap;">‚ûï Add</button></div><div id="char-grid" class="char-grid"></div></div></div><div class="section"><h3>Current Character</h3><div id="current-char" style="font-size: 48px; text-align: center; padding: 20px;">-</div></div><div class="section"><h3 class="collapsible-header collapsed" id="kerning-header">Kerning Pairs (SVG hkern) <span class="collapse-icon">‚ñº</span></h3><div class="collapsible-content collapsed" id="kerning-content"><div class="input-group"><label>First Glyph (u1 or g1)</label><input type="text" id="kerning-u1" placeholder="A, A-Z, or glyph-name" title="Single char, range (A-Z), comma-separated list (A,V,W), or glyph name" /></div><div class="input-group"><label>Second Glyph (u2 or g2)</label><input type="text" id="kerning-u2" placeholder="V, a-z, or glyph-name" title="Single char, range (a-z), comma-separated list (a,e,o), or glyph name" /></div><div class="input-group"><label>Type</label><select id="kerning-type"><option value="unicode">Unicode (u1/u2)</option><option value="glyph">Glyph Name (g1/g2)</option></select></div><div class="input-group"><label>Kern Value (k) - Positive decreases spacing</label><input type="number" id="kerning-value" value="2" step="0.5" title="Positive: decrease spacing (closer). Negative: increase spacing (further apart)" /></div><button id="add-kerning" style="width: 100%; margin-bottom: 10px;">‚ûï Add Kerning Rule</button><div style="font-size: 11px; color: var(--secondary-color); margin-bottom: 8px;"> Examples: "A" + "V", "A-Z" + "a", "A,V,W" + "o"<br> Ranges: A-Z, a-z, 0-9. Lists: A,V,W,Y<br><strong>k</strong>: +2 = 2mm closer, -2 = 2mm further apart </div><div id="kerning-list" style="font-size: 12px; max-height: 150px; overflow-y: auto;"></div></div></div></aside><div class="center-panel"><div class="canvas-container"><canvas id="drawing-canvas" width="600" height="600"></canvas></div><div class="toolbar"><div style="margin-bottom: 10px;"><div class="status" id="status" style="margin-bottom: 5px; font-size: 16px; font-weight: 500;">Draw to create character</div><div style="display: flex; gap: 5px;"><button id="prev-char" style="flex: 1; white-space: nowrap;">‚óÄ Prev</button><button id="next-char" style="flex: 1; white-space: nowrap;">Next ‚ñ∂</button></div></div><div style="display: flex; flex-wrap: wrap; gap: 5px;"><button id="undo" style="flex: 1 1 120px; white-space: nowrap;">‚Ü∂ Undo</button><button id="redo" style="flex: 1 1 120px; white-space: nowrap;">‚Ü∑ Redo</button><button id="clear-char" style="flex: 1 1 120px; white-space: nowrap;">üóëÔ∏è Clear</button><button id="delete-char" style="flex: 1 1 120px; white-space: nowrap; display: none;">‚ùå Delete</button><button id="toggle-guides" style="flex: 1 1 120px; white-space: nowrap;">üìè Guides</button></div></div></div></div></div><div id="font-preview-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;"><div style="background: var(--bg-color); border-radius: 8px; padding: 20px; max-width: 90%; max-height: 90%; overflow: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3); display: flex; flex-direction: column;"><div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;"><h2 style="margin: 0;">Font Preview</h2><button id="close-preview" style="padding: 8px 16px; cursor: pointer;">‚úï Close</button></div><div style="overflow: auto; flex: 1;"><canvas id="preview-canvas" width="1200" height="1200" style="border: 1px solid var(--border-color); display: block;"></canvas></div></div></div><div class="tab-content" id="text-to-gcode"><div class="main-container" style="justify-content: center;"><div style="max-width: 800px; width: 100%; padding: 20px; overflow-y: auto;"><div class="section"><h3>Font Selection</h3><div class="input-group"><label>Font</label><select id="font-selector" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--bg-color); color: var(--text-color);"><option value="">Select a font...</option></select></div></div><div class="section"><h3>Text to Engrave</h3><div class="input-group"><label>Text</label><textarea id="text-input" placeholder="Enter text..." style="min-height: 100px;">Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.</textarea></div></div><div class="section"><h3>Output Settings</h3><div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;"><div class="input-group"><label>Output Size (mm)</label><input type="number" id="output-size" value="30" step="1" min="0.5" /></div><div class="input-group"><label>Character Spacing (mm)</label><input type="number" id="char-spacing" value="0" step="0.1" min="0" /></div><div class="input-group"><label>Space Width (mm)</label><input type="number" id="space-width" value="0" step="0.1" min="0" /></div><div class="input-group"><label>Line Gap (mm)</label><input type="number" id="line-spacing" value="0" step="0.1" min="0" /></div><div class="input-group"><label>Max Width (mm, 0=none)</label><input type="number" id="max-width" value="0" step="10" min="0" /></div><div class="input-group"><label>Max Height (mm, 0=none)</label><input type="number" id="max-height" value="0" step="10" min="0" /></div><div class="input-group"><label>Max Text Size (mm)</label><input type="number" id="max-text-size" value="100" step="1" min="1" /></div><div class="input-group" style="grid-column: 1 / -1;"><label style="display: flex; align-items: center; cursor: pointer;"><input type="checkbox" id="auto-fit" style="margin-right: 8px;" /> Auto-fit to Max Width/Height (scales output size to maximize within constraints) </label></div><div class="input-group"><label>Feed Rate (mm/min)</label><input type="number" id="feed-rate" value="1000" step="50" min="10" /></div><div class="input-group"><label>Plunge Rate (mm/min)</label><input type="number" id="plunge-rate" value="200" step="50" min="10" /></div><div class="input-group"><label>Safe Z (mm)</label><input type="number" id="safe-z" value="5" step="0.5" /></div><div class="input-group"><label>Engrave Depth (mm)</label><input type="number" id="engrave-depth" value="-0.2" step="0.05" /></div></div></div><div class="section"><button id="preview-gcode-btn" class="primary" style="width: 100%; font-size: 16px; padding: 12px;">üé¨ Preview GCode</button></div></div></div></div><div class="tab-content" id="gcode-preview"><div class="container" style="height: 100%;"><aside class="left-sidebar" id="preview-gcode-sidebar"><div class="panel" id="gcode-panel"><h3>GCode <span id="gcode-line-indicator" style="font-size: 12px; opacity: 0.7;"></span></h3><div id="gcode-container"><div id="gcode-content"><div class="gcode-line-numbers" id="gcode-line-numbers"></div><div class="gcode-code" id="gcode-display"></div></div></div></div><div class="panel" id="gcode-welcome" style="display: none;"><div style="margin-top: 0;"><h3>GCode Preview</h3><p style="font-size: 14px; line-height: 1.6; opacity: 0.9;"> Click "Preview GCode" in the "Text To GCode" tab to generate and visualize your toolpath here. </p><p style="font-size: 14px; line-height: 1.6; opacity: 0.9; margin-top: 10px;"> This viewer uses the same rendering engine as the standalone GCode viewer, supporting 2D/3D views, animation, and all advanced features. </p></div><div style="margin-top: 20px;"><h3>Navigation</h3><ul style="font-size: 14px; line-height: 1.8; list-style: circle; padding-left: 20px; opacity: 0.9;"><li><strong>2D View:</strong> Left or right click drag to pan, scroll to zoom</li><li><strong>3D View:</strong> Left click and drag to rotate, right click and drag to pan, scroll to zoom</li><li><strong>Mobile:</strong> One finger drag to rotate, two finger drag to pan, pinch to zoom</li><li><strong>Reset:</strong> Click "Reset View" to re-center</li></ul></div></div></aside><div class="canvas-container"><div class="canvas-overlay-controls"><button id="btn-toggle-view">3D View</button><button id="btn-reset-view" disabled>Reset View</button></div><canvas id="canvas2d"></canvas><canvas id="canvas3d" class="hidden"></canvas><canvas id="canvas3d-overlay" class="hidden"></canvas></div><aside class="sidebar" id="preview-sidebar"><div class="panel"><h3>Export</h3><button id="download-gcode" style="width: 100%; font-size: 14px; padding: 10px; margin-bottom: 8px;">üíæ Download GCode</button><button id="export-image" style="width: 100%; font-size: 14px; padding: 10px; margin-bottom: 8px;">üñºÔ∏è Export Image</button><button id="export-svg" style="width: 100%; font-size: 14px; padding: 10px; margin-bottom: 8px;">üìê Export SVG</button><button id="export-dxf" style="width: 100%; font-size: 14px; padding: 10px; margin-bottom: 8px;">üìè Export DXF</button><button id="export-svg-font" style="width: 100%; font-size: 14px; padding: 10px;">üî§ Export SVG Font</button></div><div class="panel"><h3>Statistics</h3><div class="stats-grid"><div class="stat-item"><div class="stat-label">Segments</div><div class="stat-value" id="stat-lines">-</div></div><div class="stat-item"><div class="stat-label">Est. Time</div><div class="stat-value" id="stat-time">-</div></div><div class="stat-item"><div class="stat-label">X Range</div><div class="stat-value" id="stat-x">-</div></div><div class="stat-item"><div class="stat-label">Y Range</div><div class="stat-value" id="stat-y">-</div></div><div class="stat-item"><div class="stat-label">Z Range</div><div class="stat-value" id="stat-z">-</div></div></div></div><div class="panel" id="tool-panel" style="display: none;"><h3>Tools</h3><div id="tool-list" style="max-height: 400px; overflow-y: auto;"></div></div><div class="panel" id="rapid-moves-panel" style="display: none;"><h3>Rapid Moves (G0)</h3><div style="display: flex; align-items: center; gap: 8px; padding: 8px; background: var(--canvas-bg); border-radius: 4px;"><input type="checkbox" id="rapid-moves-visible" checked><input type="color" id="rapid-move-color" value="#999999" style="width: 32px; height: 24px; border: none; cursor: pointer;"><label for="rapid-moves-visible" style="flex: 1; font-size: 13px; cursor: pointer;">Show Travel Moves</label></div></div><div class="panel"><h3>View Controls</h3><div class="layer-controls"><div style="margin-bottom: 10px;"><label style="font-size: 12px; display: block; margin-bottom: 5px;">Zoom</label><input type="range" id="zoom-slider" min="0.1" max="10" step="0.1" value="1" style="width: 100%;"><div style="text-align: center; font-size: 11px; margin-top: 5px;"><span id="zoom-value">100%</span></div></div></div></div><div class="panel" id="animation-panel" style="display: none;"><h3>Animation</h3><div class="animation-controls"><div class="controls-row"><button id="btn-play">Play</button><button id="btn-reset">Reset</button></div><div class="controls-row"><button id="btn-prev">‚óÄ Prev</button><button id="btn-next">Next ‚ñ∂</button></div><div><label>Speed: <span id="speed-label">1x</span></label><input type="range" id="speed-slider" min="-10" max="10" value="0" step="1"></div><div style="margin-top: 10px;"><label style="font-size: 12px; display: block; margin-bottom: 5px;">Segment: <span id="current-line">0</span> / <span id="total-lines">0</span></label><div style="font-size: 11px; opacity: 0.7; margin-bottom: 5px;">File Line: <span id="current-file-line">-</span></div><input type="range" id="line-slider" min="0" max="0" step="1" value="0" style="width: 100%;"></div></div></div><div class="panel"><h3>Layer Filter</h3><div class="layer-controls"><div class="layer-inputs"><div><label style="font-size: 12px;">Min Z</label><input type="number" id="layer-min" step="0.1" placeholder="Auto"></div><div><label style="font-size: 12px;">Max Z</label><input type="number" id="layer-max" step="0.1" placeholder="Auto"></div></div></div></div><div class="panel"><h3>3D Grid</h3><div class="layer-controls"><div style="margin-bottom: 10px;"><label style="display: flex; align-items: center; gap: 8px;"><input type="checkbox" id="grid-enabled" checked><span>Show Grid</span></label></div><div class="layer-inputs"><div><label style="font-size: 12px;">Width (X)</label><input type="number" id="grid-width" step="10" value="200" min="0"></div><div><label style="font-size: 12px;">Height (Y)</label><input type="number" id="grid-height" step="10" value="200" min="0"></div></div></div></div><div class="privacy-notice"> üîí All processing happens locally in your browser.<br>No data is transmitted. </div></aside></div></div><script>class GCodeParser{constructor(){this.reset()}reset(){this.position={x:0,y:0,z:0},this.units="mm",this.absolute=!0,this.plane="XY",this.feedRate=0,this.currentTool=1,this.motionMode=null,this.toolNames=[],this.toolColors=[],this.parsingToolList=!1,this.inlineToolMap=new Map,this.inlineToolOccurrence=new Map,this.lastToolChangeType=null,this.segments=[],this.bounds={minX:1/0,maxX:-1/0,minY:1/0,maxY:-1/0,minZ:1/0,maxZ:-1/0}}async parseString(t,e){this.reset();const s=t.split("\n"),i=s.length;for(let t=0;t<i;t++)this.parseLine(s[t].trim(),t+1),e&&t%1e3==0&&e(Math.min(100,(t+1)/i*100));return e&&e(100),this.segments}async parseFile(t,e){this.reset();const s=await t.text();return this.parseString(s,e)}readChunk(t,e,s){return new Promise((i,n)=>{const o=new FileReader,a=t.slice(e,e+s);o.onload=t=>i(t.target.result),o.onerror=n,o.readAsText(a)})}parseLine(t,e){if(t.startsWith(";")||t.startsWith("(")){const e=t.replace(/^[;(]/,"").replace(/\)$/,"").trim(),s=e.match(/^Tool\s+(\d+)\s*:\s*(.+)$/i);if(s){0===this.toolNames.length&&(this.toolNames.push("No Tool"),this.toolColors.push(null),this.currentTool=0);const t=parseInt(s[1]),e=s[2].trim(),i=e.match(/#([0-9A-Fa-f]{6})\b/),n=i?e.replace(/#[0-9A-Fa-f]{6}\b/,"").trim():e,o=i?"#"+i[1]:null;this.inlineToolMap.has(t)||this.inlineToolMap.set(t,[]);const a=this.inlineToolMap.get(t),r=this.toolNames.length;return a.push(r),1===a.length?this.toolNames.push(`Tool ${t}: ${n}`):this.toolNames.push(`Tool ${t}: ${n} (${a.length})`),void this.toolColors.push(o)}if(/required tools?:/i.test(e))return void(this.parsingToolList=!0);if(this.parsingToolList){if(!e||0===e.length)return void(this.parsingToolList=!1);if(e.length>0&&!e.toLowerCase().includes("required")){const t=e.match(/#([0-9A-Fa-f]{6})\b/);if(t){this.toolColors.push("#"+t[1]);const s=e.replace(/#[0-9A-Fa-f]{6}\b/,"").trim();this.toolNames.push(s)}else this.toolColors.push(null),this.toolNames.push(e)}return}return}if(!t||t.startsWith("%"))return;const s=t,i=/M0\b/i.test(t),n=s.match(/[;(](.*)$/),o=n?n[1].toLowerCase():"";if(i&&o.includes("tool")&&(this.currentTool++,this.lastToolChangeType="M0"),!(t=t.replace(/\(.*?\)/g,"").replace(/;.*$/,"").trim()))return;const a=this.extractWords(t);if(0===a.length)return;let r=!1;for(const[t,s]of a)switch(t){case"G":const t=Math.floor(s);(0===t||1===t||2===t||3===t)&&(r=!0),this.processGCode(t,a,e);break;case"M":this.processMCode(Math.floor(s),a,e);break;case"T":const i=Math.floor(s);if(this.inlineToolMap.size>0&&this.inlineToolMap.has(i)){const t=this.inlineToolMap.get(i),e=this.inlineToolOccurrence.get(i)||0,s=Math.min(e,t.length-1);this.currentTool=t[s],this.inlineToolOccurrence.set(i,e+1)}else this.currentTool=i;break;case"F":this.feedRate=s}r||null===this.motionMode||a.some(([t])=>"X"===t||"Y"===t||"Z"===t)&&(0===this.motionMode||1===this.motionMode?this.processGCode(this.motionMode,a,e):2!==this.motionMode&&3!==this.motionMode||a.some(([t])=>"I"===t||"J"===t||"K"===t)&&this.processGCode(this.motionMode,a,e))}extractWords(t){const e=[],s=/([A-Z])([+-]?\d+\.?\d*)/gi;let i;for(;null!==(i=s.exec(t));)e.push([i[1].toUpperCase(),parseFloat(i[2])]);return e}processMCode(t,e,s){6===t&&(this.lastToolChangeType="M6")}processGCode(t,e,s){switch(t){case 0:return this.motionMode=0,this.linearMove(e,"rapid",s);case 1:return this.motionMode=1,this.linearMove(e,"cut",s);case 2:return this.motionMode=2,this.arcMove(e,"cw",s);case 3:return this.motionMode=3,this.arcMove(e,"ccw",s);case 17:return this.plane="XY",!1;case 18:return this.plane="ZX",!1;case 19:return this.plane="YZ",!1;case 20:return this.units="inches",!1;case 21:return this.units="mm",!1;case 90:return this.absolute=!0,!1;case 91:return this.absolute=!1,!1;default:return!1}}linearMove(t,e,s){const i=this.extractTarget(t);return(i.x!==this.position.x||i.y!==this.position.y||i.z!==this.position.z)&&(this.addSegment({type:e,start:{...this.position},end:{...i},feedRate:this.feedRate,tool:this.currentTool,toolChangeType:this.lastToolChangeType,lineNum:s}),this.lastToolChangeType=null,this.position=i,this.updateBounds(i),!0)}arcMove(t,e,s){const i=this.extractTarget(t),n=this.extractOffset(t);if(!n)return console.error(`Arc command at line ${s} missing I/J/K parameters`),!1;const o=this.tessellateArc(this.position,i,n,"cw"===e);for(const t of o)this.addSegment({type:"cut",start:t.start,end:t.end,feedRate:this.feedRate,tool:this.currentTool,lineNum:s}),this.updateBounds(t.end);return this.position=i,o.length>0}extractTarget(t){const e={...this.position};for(const[s,i]of t){const t=this.absolute?i:this.position[s.toLowerCase()]+i;switch(s){case"X":e.x=t;break;case"Y":e.y=t;break;case"Z":e.z=t}}return e}extractOffset(t){let e=null;for(const[s,i]of t)"I"!==s&&"J"!==s&&"K"!==s||(e||(e={i:0,j:0,k:0}),e[s.toLowerCase()]=i);return e}tessellateArc(t,e,s,i){let n,o,a,r,h,c;"XY"===this.plane?(n=t.x+s.i,o=t.y+s.j,a=t.x,r=t.y,h=e.x,c=e.y):"ZX"===this.plane?(n=t.z+s.k,o=t.x+s.i,a=t.z,r=t.x,h=e.z,c=e.x):(n=t.y+s.j,o=t.z+s.k,a=t.y,r=t.z,h=e.y,c=e.z);const l=Math.sqrt(Math.pow(a-n,2)+Math.pow(r-o,2)),d=Math.atan2(r-o,a-n);let u=Math.atan2(c-o,h-n)-d;i?u>=0&&(u-=2*Math.PI):u<=0&&(u+=2*Math.PI);const g=Math.max(8,Math.min(64,Math.floor(Math.sqrt(l)*Math.abs(u)*4))),m=[];let f={...t};for(let s=1;s<=g;s++){const i=s/g,a=d+u*i,r={...t};"XY"===this.plane?(r.x=n+l*Math.cos(a),r.y=o+l*Math.sin(a),r.z=t.z+(e.z-t.z)*i):"ZX"===this.plane?(r.z=n+l*Math.cos(a),r.x=o+l*Math.sin(a),r.y=t.y+(e.y-t.y)*i):(r.y=n+l*Math.cos(a),r.z=o+l*Math.sin(a),r.x=t.x+(e.x-t.x)*i),m.push({start:f,end:r}),f=r}return m}addSegment(t){this.segments.push(t)}updateBounds(t){isNaN(t.x)||isNaN(t.y)||isNaN(t.z)?console.error("Invalid point in updateBounds:",t):(this.bounds.minX=Math.min(this.bounds.minX,t.x),this.bounds.maxX=Math.max(this.bounds.maxX,t.x),this.bounds.minY=Math.min(this.bounds.minY,t.y),this.bounds.maxY=Math.max(this.bounds.maxY,t.y),this.bounds.minZ=Math.min(this.bounds.minZ,t.z),this.bounds.maxZ=Math.max(this.bounds.maxZ,t.z))}getBounds(){return this.bounds}getSegments(){return this.segments}getToolNames(){return this.toolNames}getToolColors(){return this.toolColors}get usingInlineToolFormat(){return this.inlineToolMap.size>0}}class Camera{constructor(){this.position={x:0,y:0,z:100},this.target={x:0,y:0,z:0},this.rotation={x:0,y:0,z:0,w:1},this.zoom=1,this.orthoScale=100,this.targetPosition={...this.position},this.targetTarget={...this.target},this.targetRotation={...this.rotation},this.targetZoom=this.zoom,this.pan2d={x:0,y:0},this.zoom2d=1,this.targetPan2d={...this.pan2d},this.targetZoom2d=this.zoom2d,this.initialZoom2d=1,this.initialOrthoScale=100}fitToBounds(t,e=.1,s=800,i=600){const n=(t.minX+t.maxX)/2,o=(t.minY+t.maxY)/2,a=(t.minZ+t.maxZ)/2;this.target={x:n,y:o,z:a},this.targetTarget={x:n,y:o,z:a};const r=t.maxX-t.minX,h=t.maxY-t.minY,c=t.maxZ-t.minZ,l=Math.max(r,h,c)||100;this.orthoScale=l*(.6+e/2);const d=s>0?s:800,u=i>0?i:600,g=d/Math.max(r*(1+.5*e),1),m=u/Math.max(h*(1+.5*e),1),f=Math.min(g,m);console.log("Camera fitToBounds:",{bounds:{width:r,height:h},canvas:{width:d,height:u},center:{x:n,y:o},scales:{x:g,y:m,chosen:f}}),this.pan2d={x:n,y:o},this.zoom2d=f,this.targetPan2d={...this.pan2d},this.targetZoom2d=this.zoom2d,this.initialZoom2d=f,this.initialOrthoScale=this.orthoScale,this.position={x:n+2*l,y:o,z:a},this.targetPosition={x:n,y:o,z:a+2*l},this.rotation={x:0,y:0,z:0,w:1},this.targetRotation={x:0,y:0,z:0,w:1}}update(t=16){const e=.15;this.pan2d.x+=(this.targetPan2d.x-this.pan2d.x)*e,this.pan2d.y+=(this.targetPan2d.y-this.pan2d.y)*e,this.zoom2d+=(this.targetZoom2d-this.zoom2d)*e,this.position.x+=(this.targetPosition.x-this.position.x)*e,this.position.y+=(this.targetPosition.y-this.position.y)*e,this.position.z+=(this.targetPosition.z-this.position.z)*e,this.target.x+=(this.targetTarget.x-this.target.x)*e,this.target.y+=(this.targetTarget.y-this.target.y)*e,this.target.z+=(this.targetTarget.z-this.target.z)*e,this.rotation=this.slerpQuaternion(this.rotation,this.targetRotation,e),this.zoom+=(this.targetZoom-this.zoom)*e}pan2D(t,e){this.targetPan2d.x-=t/this.zoom2d,this.targetPan2d.y+=e/this.zoom2d}zoom2D(t,e,s,i,n,o=!1){const a=1-t*(o?.015:.001),r=this.get2DTransform(i,n),h=(e-r.translateX)/r.scale,c=(s-r.translateY)/r.scale;this.targetZoom2d,this.targetZoom2d*=a;const l=.1*this.initialZoom2d,d=10*this.initialZoom2d;this.targetZoom2d=Math.max(l,Math.min(d,this.targetZoom2d));const u=e-h*this.targetZoom2d,g=s-c*this.targetZoom2d;this.targetPan2d.x=(i/2-u)/this.targetZoom2d,this.targetPan2d.y=-(n/2-g)/this.targetZoom2d}rotate(t,e){const s=this.position,i=this.target,n={x:i.x-s.x,y:i.y-s.y,z:i.z-s.z},o=Math.sqrt(n.x*n.x+n.y*n.y+n.z*n.z);n.x/=o,n.y/=o,n.z/=o;const a={x:1*n.z-0*n.y,y:0*n.x-0*n.z,z:0*n.y-1*n.x},r=Math.sqrt(a.x*a.x+a.y*a.y+a.z*a.z);a.x/=r,a.y/=r,a.z/=r;const h=n.y*a.z-n.z*a.y,c=n.z*a.x-n.x*a.z,l=n.x*a.y-n.y*a.x,d=s.x-i.x,u=s.y-i.y,g=s.z-i.z,m=.01*-t,f=Math.cos(m),p=Math.sin(m);let x=d*(f+h*h*(1-f))+u*(h*c*(1-f)-l*p)+g*(h*l*(1-f)+c*p),y=d*(c*h*(1-f)+l*p)+u*(f+c*c*(1-f))+g*(c*l*(1-f)-h*p),v=d*(l*h*(1-f)-c*p)+u*(l*c*(1-f)+h*p)+g*(f+l*l*(1-f));const b=.01*e,E=Math.cos(b),C=Math.sin(b),M=x*(E+a.x*a.x*(1-E))+y*(a.x*a.y*(1-E)-a.z*C)+v*(a.x*a.z*(1-E)+a.y*C),I=x*(a.y*a.x*(1-E)+a.z*C)+y*(E+a.y*a.y*(1-E))+v*(a.y*a.z*(1-E)-a.x*C),S=x*(a.z*a.x*(1-E)-a.y*C)+y*(a.z*a.y*(1-E)+a.x*C)+v*(E+a.z*a.z*(1-E)),w=I/Math.sqrt(M*M+I*I+S*S),T=Math.asin(-w),z=Math.PI/2-.09;Math.abs(T)>z?(this.targetPosition.x=i.x+x,this.targetPosition.y=i.y+y,this.targetPosition.z=i.z+v):(this.targetPosition.x=i.x+M,this.targetPosition.y=i.y+I,this.targetPosition.z=i.z+S)}pan3D(t,e){const s=.002*this.orthoScale,i=this.position,n=this.target,o={x:n.x-i.x,y:n.y-i.y,z:n.z-i.z},a=Math.sqrt(o.x*o.x+o.y*o.y+o.z*o.z);o.x/=a,o.y/=a,o.z/=a;const r={x:1*o.z-0*o.y,y:0*o.x-0*o.z,z:0*o.y-1*o.x},h=Math.sqrt(r.x*r.x+r.y*r.y+r.z*r.z);r.x/=h,r.y/=h,r.z/=h;const c={x:o.y*r.z-o.z*r.y,y:o.z*r.x-o.x*r.z,z:o.x*r.y-o.y*r.x},l=Math.sqrt(c.x*c.x+c.y*c.y+c.z*c.z);c.x/=l,c.y/=l,c.z/=l,this.targetPosition.x+=t*s*r.x+e*s*c.x,this.targetPosition.y+=t*s*r.y+e*s*c.y,this.targetPosition.z+=t*s*r.z+e*s*c.z,this.targetTarget.x+=t*s*r.x+e*s*c.x,this.targetTarget.y+=t*s*r.y+e*s*c.y,this.targetTarget.z+=t*s*r.z+e*s*c.z}zoom3D(t){const e=t*(Math.abs(t)>10?.001:1);this.orthoScale*=1+e;const s=.1*this.initialOrthoScale,i=10*this.initialOrthoScale;this.orthoScale=Math.max(s,Math.min(i,this.orthoScale))}get2DTransform(t,e){return{translateX:t/2-this.pan2d.x*this.zoom2d,translateY:e/2+this.pan2d.y*this.zoom2d,scale:this.zoom2d}}getProjectionMatrix(t){const e=this.orthoScale,s=-e*t,i=e*t,n=-e,o=i-s,a=e-n;return[2/o,0,0,0,0,2/a,0,0,0,0,-1e-4,0,-(i+s)/o,-(e+n)/a,-0,1]}getViewMatrix(){const t=this.position,e=this.target,s={x:t.x-e.x,y:t.y-e.y,z:t.z-e.z},i=Math.sqrt(s.x*s.x+s.y*s.y+s.z*s.z);s.x/=i,s.y/=i,s.z/=i;const n={x:1*s.z-0*s.y,y:0*s.x-0*s.z,z:0*s.y-1*s.x},o=Math.sqrt(n.x*n.x+n.y*n.y+n.z*n.z);n.x/=o,n.y/=o,n.z/=o;const a={x:s.y*n.z-s.z*n.y,y:s.z*n.x-s.x*n.z,z:s.x*n.y-s.y*n.x};return[n.x,a.x,s.x,0,n.y,a.y,s.y,0,n.z,a.z,s.z,0,-(n.x*t.x+n.y*t.y+n.z*t.z),-(a.x*t.x+a.y*t.y+a.z*t.z),-(s.x*t.x+s.y*t.y+s.z*t.z),1]}axisAngleToQuaternion(t,e){const s=e/2,i=Math.sin(s);return{x:t.x*i,y:t.y*i,z:t.z*i,w:Math.cos(s)}}multiplyQuaternion(t,e){return{x:t.w*e.x+t.x*e.w+t.y*e.z-t.z*e.y,y:t.w*e.y-t.x*e.z+t.y*e.w+t.z*e.x,z:t.w*e.z+t.x*e.y-t.y*e.x+t.z*e.w,w:t.w*e.w-t.x*e.x-t.y*e.y-t.z*e.z}}normalizeQuaternion(t){const e=Math.sqrt(t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w);return{x:t.x/e,y:t.y/e,z:t.z/e,w:t.w/e}}slerpQuaternion(t,e,s){let i=t.x*e.x+t.y*e.y+t.z*e.z+t.w*e.w;if(i<0&&(e={x:-e.x,y:-e.y,z:-e.z,w:-e.w},i=-i),i>.9995)return this.normalizeQuaternion({x:t.x+s*(e.x-t.x),y:t.y+s*(e.y-t.y),z:t.z+s*(e.z-t.z),w:t.w+s*(e.w-t.w)});const n=Math.acos(i),o=Math.sin(n),a=Math.sin((1-s)*n)/o,r=Math.sin(s*n)/o;return{x:t.x*a+e.x*r,y:t.y*a+e.y*r,z:t.z*a+e.z*r,w:t.w*a+e.w*r}}quaternionToMatrix(t){const e=t.x*t.x,s=t.y*t.y,i=t.z*t.z,n=t.x*t.y,o=t.x*t.z,a=t.y*t.z,r=t.w*t.x,h=t.w*t.y,c=t.w*t.z;return[1-2*(s+i),2*(n-c),2*(o+h),0,2*(n+c),1-2*(e+i),2*(a-r),0,2*(o-h),2*(a+r),1-2*(e+s),0,0,0,0,1]}multiplyMatrices(t,e){const s=new Array(16);for(let i=0;i<4;i++)for(let n=0;n<4;n++)s[4*i+n]=t[0+n]*e[4*i+0]+t[4+n]*e[4*i+1]+t[8+n]*e[4*i+2]+t[12+n]*e[4*i+3];return s}getMVPMatrix(t){const e=this.getProjectionMatrix(t),s=this.getViewMatrix();return this.multiplyMatrices(e,s)}}class Renderer2D{constructor(t,e){this.canvas=t,this.ctx=t.getContext("2d"),this.camera=e,this.segments=[],this.bounds=null,this.layerFilter={min:-1/0,max:1/0},this.hoveredPoint=null,this.maxSegmentIndex=1/0,this.toolStates=new Map,this.rapidMovesVisible=!0,this.rapidMoveColor="#999999",this.resizeCanvas()}resizeCanvas(){const t=this.canvas.getBoundingClientRect();this.canvas.width=t.width,this.canvas.height=t.height}setSegments(t,e){this.segments=t,this.bounds=e,this.maxSegmentIndex=t.length}setToolStates(t){this.toolStates=t}setRapidMoveSettings(t,e){this.rapidMovesVisible=t,this.rapidMoveColor=e}updateBuffers(){}setLayerFilter(t,e){this.layerFilter.min=t,this.layerFilter.max=e}setMaxSegmentIndex(t,e=1){this.maxSegmentIndex=t,this.segmentProgress=e}render(){if(this.resizeCanvas(),this.clear(),0===this.segments.length)return void this.drawWelcomeMessage();const t=this.camera.get2DTransform(this.canvas.width,this.canvas.height);this.ctx.save(),this.ctx.translate(t.translateX,t.translateY),this.ctx.scale(t.scale,-t.scale),this.drawGrid(t),this.drawSegments(),this.drawCurrentPositionMarker(),this.ctx.restore(),this.drawGridLabels(t),this.drawCoordinateAxes()}clear(){const t=document.documentElement.getAttribute("data-theme");this.ctx.fillStyle="dark"===t?"#252525":"#fafafa",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)}drawWelcomeMessage(){this.ctx.save(),this.ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue("--text-color"),this.ctx.font="16px sans-serif",this.ctx.textAlign="center",this.ctx.fillText("Load a GCode file to visualize",this.canvas.width/2,this.canvas.height/2),this.ctx.restore()}drawGrid(t){const e=document.documentElement.getAttribute("data-theme"),s="dark"===e?"#3a3a3a":"#e0e0e0",i=t.scale;let n=10;i<.5?n=100:i<2?n=50:i>10?n=1:i>5&&(n=5);const o=-t.translateX/i,a=(this.canvas.width-t.translateX)/i,r=t.translateY/i,h=(t.translateY-this.canvas.height)/i;this.ctx.strokeStyle=s,this.ctx.lineWidth=1/i;const c=Math.floor(o/n)*n,l=Math.ceil(a/n)*n;for(let t=c;t<=l;t+=n)this.ctx.beginPath(),this.ctx.moveTo(t,h),this.ctx.lineTo(t,r),this.ctx.stroke();const d=Math.floor(h/n)*n,u=Math.ceil(r/n)*n;for(let t=d;t<=u;t+=n)this.ctx.beginPath(),this.ctx.moveTo(o,t),this.ctx.lineTo(a,t),this.ctx.stroke();this.ctx.strokeStyle="dark"===e?"#666666":"#999999",this.ctx.lineWidth=2/i,this.ctx.beginPath(),this.ctx.moveTo(0,h),this.ctx.lineTo(0,r),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(o,0),this.ctx.lineTo(a,0),this.ctx.stroke()}drawSegments(){const t=document.documentElement.getAttribute("data-theme"),e=["dark"===t?"#00ccff":"#0066cc","dark"===t?"#00ff88":"#00cc66","dark"===t?"#ff4dff":"#cc00cc","dark"===t?"#ffff00":"#cccc00","dark"===t?"#ff8800":"#ff6600","dark"===t?"#8888ff":"#4d4dff","dark"===t?"#ff0088":"#ff0066","dark"===t?"#00ffff":"#00b3b3"],s=this.camera.zoom2d,i=Math.max(.5,1.5/s),n=[],o={};let a=null;for(let t=0;t<Math.min(this.segments.length,this.maxSegmentIndex);t++){const e=this.segments[t];if(!(e.start.z<this.layerFilter.min||e.start.z>this.layerFilter.max))if("rapid"===e.type)this.rapidMovesVisible&&n.push(e);else{const t=e.tool||0;if(this.toolStates.has(t)&&!this.toolStates.get(t).visible)continue;o[t]||(o[t]=[]),o[t].push(e)}}if(this.maxSegmentIndex<this.segments.length&&this.segmentProgress>0&&this.segmentProgress<1){const t=this.segments[this.maxSegmentIndex];if("cut"===t.type&&t.start.z>=this.layerFilter.min&&t.start.z<=this.layerFilter.max){const e=t.tool||0;this.toolStates.has(e)&&!this.toolStates.get(e).visible||(a={seg:t,tool:e})}}this.rapidMovesVisible&&n.length>0&&(this.ctx.strokeStyle=this.rapidMoveColor,this.ctx.lineWidth=.7*i,this.ctx.setLineDash([5/s,5/s]),this.drawSegmentBatch(n)),this.ctx.lineWidth=i,this.ctx.setLineDash([]);for(const t in o){const s=parseInt(t);if(this.toolStates.has(s))this.ctx.strokeStyle=this.toolStates.get(s).color;else{const t=s%e.length;this.ctx.strokeStyle=e[t]}this.drawSegmentBatch(o[t])}if(a){const{seg:t,tool:s}=a;if(this.toolStates.has(s))this.ctx.strokeStyle=this.toolStates.get(s).color;else{const t=s%e.length;this.ctx.strokeStyle=e[t]}const i=t.start.x+(t.end.x-t.start.x)*this.segmentProgress,n=t.start.y+(t.end.y-t.start.y)*this.segmentProgress;t.start.z,t.end.z,t.start.z,this.segmentProgress,this.ctx.beginPath(),this.ctx.moveTo(t.start.x,t.start.y),this.ctx.lineTo(i,n),this.ctx.stroke()}}drawSegmentBatch(t){if(0!==t.length){this.ctx.beginPath();for(const e of t)this.ctx.moveTo(e.start.x,e.start.y),this.ctx.lineTo(e.end.x,e.end.y);this.ctx.stroke()}}drawCurrentPositionMarker(){if(this.maxSegmentIndex>=this.segments.length||this.maxSegmentIndex===1/0)return;const t=this.segments[this.maxSegmentIndex];if(!t)return;const e=this.segmentProgress,s={x:t.start.x+(t.end.x-t.start.x)*e,y:t.start.y+(t.end.y-t.start.y)*e,z:t.start.z+(t.end.z-t.start.z)*e},i=this.camera.zoom2d,n=5/i;this.ctx.save(),this.ctx.fillStyle="#ff0000",this.ctx.strokeStyle="#ffffff",this.ctx.lineWidth=2/i,this.ctx.beginPath(),this.ctx.arc(s.x,s.y,n,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke(),this.ctx.restore()}drawGridLabels(t){const e=document.documentElement.getAttribute("data-theme"),s=t.scale;let i=10;s<.5?i=100:s<2?i=50:s>10?i=1:s>5&&(i=5);const n=Math.max(i,10),o=-t.translateX/s,a=(this.canvas.width-t.translateX)/s,r=t.translateY/s,h=(t.translateY-this.canvas.height)/s;this.ctx.save(),this.ctx.fillStyle="dark"===e?"#aaa":"#555",this.ctx.font="11px monospace",this.ctx.textAlign="center",this.ctx.textBaseline="middle";const c=e=>t.translateX+e*s,l=e=>t.translateY-e*s,d=Math.floor(o/n)*n,u=Math.ceil(a/n)*n;for(let t=d;t<=u;t+=n){const e=c(t),s=l(0);let i=s+15;s<0?i=15:s>this.canvas.height&&(i=this.canvas.height-5),e>=0&&e<=this.canvas.width&&this.ctx.fillText(t.toString(),e,i)}const g=Math.floor(h/n)*n,m=Math.ceil(r/n)*n;this.ctx.textAlign="right";for(let t=g;t<=m;t+=n){const e=c(0),s=l(t);let i=e-10;e<0?i=50:e>this.canvas.width&&(i=this.canvas.width-10),s>=0&&s<=this.canvas.height&&this.ctx.fillText(t.toString(),i,s)}this.ctx.restore()}drawCoordinateAxes(){const t=this.canvas.height-20-40;this.ctx.save(),this.ctx.translate(60,t),this.ctx.strokeStyle="#ff0000",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.moveTo(0,0),this.ctx.lineTo(40,0),this.ctx.stroke(),this.ctx.fillStyle="#ff0000",this.ctx.font="12px sans-serif",this.ctx.fillText("X",45,5),this.ctx.strokeStyle="#00ff00",this.ctx.beginPath(),this.ctx.moveTo(0,0),this.ctx.lineTo(0,-40),this.ctx.stroke(),this.ctx.fillStyle="#00ff00",this.ctx.fillText("Y",5,-45),this.ctx.restore()}canvasToWorld(t,e){const s=this.camera.get2DTransform(this.canvas.width,this.canvas.height);return{x:(t-s.translateX)/s.scale,y:-(e-s.translateY)/s.scale}}findNearestPoint(t,e,s=10){const i=this.canvasToWorld(t,e);let n=null,o=s/this.camera.zoom2d;for(let t=0;t<Math.min(this.segments.length,this.maxSegmentIndex);t++){const e=this.segments[t],s=Math.sqrt(Math.pow(e.start.x-i.x,2)+Math.pow(e.start.y-i.y,2));s<o&&(o=s,n={...e.start,lineNum:e.lineNum});const a=Math.sqrt(Math.pow(e.end.x-i.x,2)+Math.pow(e.end.y-i.y,2));a<o&&(o=a,n={...e.end,lineNum:e.lineNum})}return n}}class Renderer3D{constructor(t,e,s){this.canvas=t,this.camera=e,this.overlayCanvas=s,this.overlayCtx=s?s.getContext("2d"):null,this.gl=null,this.program=null,this.buffers={},this.segments=[],this.bounds=null,this.layerFilter={min:-1/0,max:1/0},this.maxSegmentIndex=1/0,this.toolStates=new Map,this.rapidMovesVisible=!0,this.rapidMoveColor="#999999",this.initWebGL(),this.resizeCanvas()}initWebGL(){if(this.gl=this.canvas.getContext("webgl",{alpha:!1,antialias:!0,preserveDrawingBuffer:!0})||this.canvas.getContext("experimental-webgl"),!this.gl)return void console.error("WebGL not supported");console.log("WebGL context created successfully");const t=this.gl,e=this.compileShader(t.VERTEX_SHADER,"\n attribute vec3 aPosition;\n attribute vec3 aColor;\n uniform mat4 uMVP;\n varying vec3 vColor;\n \n void main() {\n gl_Position = uMVP * vec4(aPosition, 1.0);\n gl_PointSize = 10.0;\n vColor = aColor;\n }\n "),s=this.compileShader(t.FRAGMENT_SHADER,"\n precision mediump float;\n varying vec3 vColor;\n \n void main() {\n gl_FragColor = vec4(vColor, 1.0);\n }\n ");this.program=t.createProgram(),t.attachShader(this.program,e),t.attachShader(this.program,s),t.linkProgram(this.program),t.getProgramParameter(this.program,t.LINK_STATUS)?(console.log("Shader program linked successfully"),this.locations={aPosition:t.getAttribLocation(this.program,"aPosition"),aColor:t.getAttribLocation(this.program,"aColor"),uMVP:t.getUniformLocation(this.program,"uMVP")},t.enable(t.DEPTH_TEST),t.depthFunc(t.LEQUAL),this.buffers.position=t.createBuffer(),this.buffers.color=t.createBuffer()):console.error("Program link error:",t.getProgramInfoLog(this.program))}compileShader(t,e){const s=this.gl,i=s.createShader(t);return s.shaderSource(i,e),s.compileShader(i),s.getShaderParameter(i,s.COMPILE_STATUS)?i:(console.error("Shader compile error:",s.getShaderInfoLog(i)),s.deleteShader(i),null)}resizeCanvas(){const t=this.canvas.getBoundingClientRect();this.canvas.width=t.width,this.canvas.height=t.height,this.overlayCanvas&&(this.overlayCanvas.width=t.width,this.overlayCanvas.height=t.height),this.gl&&this.gl.viewport(0,0,this.canvas.width,this.canvas.height)}setSegments(t,e){this.segments=t,this.bounds=e,this.maxSegmentIndex=t.length,this.updateBuffers()}setToolStates(t){this.toolStates=t}setRapidMoveSettings(t,e){this.rapidMovesVisible=t,this.rapidMoveColor=e}setLayerFilter(t,e){this.layerFilter.min=t,this.layerFilter.max=e,this.updateBuffers()}setMaxSegmentIndex(t,e=1){this.maxSegmentIndex=t,this.segmentProgress=e,this.updateBuffers()}updateBuffers(){if(!this.gl||0===this.segments.length)return;const t=this.gl,e=document.documentElement.getAttribute("data-theme"),s=this.hexToRgb(this.rapidMoveColor),i=["dark"===e?[0,.8,1]:[0,.4,.8],"dark"===e?[0,1,.5]:[0,.8,.4],"dark"===e?[1,.3,1]:[.8,0,.8],"dark"===e?[1,1,0]:[.8,.8,0],"dark"===e?[1,.5,0]:[1,.4,0],"dark"===e?[.5,.5,1]:[.3,.3,1],"dark"===e?[1,0,.5]:[1,0,.4],"dark"===e?[0,1,1]:[0,.7,.7]],n=[],o=[];for(let t=0;t<Math.min(this.segments.length,this.maxSegmentIndex);t++){const e=this.segments[t];if(e.start.z<this.layerFilter.min||e.start.z>this.layerFilter.max)continue;if("rapid"===e.type&&!this.rapidMovesVisible)continue;const a=e.tool||0;if("rapid"!==e.type&&this.toolStates.has(a)&&!this.toolStates.get(a).visible)continue;let r;if("rapid"===e.type)r=s;else if(this.toolStates.has(a)){const t=this.toolStates.get(a).color;r=this.hexToRgb(t)}else r=i[a%i.length];n.push(e.start.x,e.start.y,e.start.z),o.push(...r),n.push(e.end.x,e.end.y,e.end.z),o.push(...r)}if(this.maxSegmentIndex<this.segments.length&&this.segmentProgress>0&&this.segmentProgress<1){const t=this.segments[this.maxSegmentIndex];if(t.start.z>=this.layerFilter.min&&t.start.z<=this.layerFilter.max&&("rapid"!==t.type||this.rapidMovesVisible)){const e=t.tool||0;let a=!0;if("rapid"!==t.type&&this.toolStates.has(e)&&(a=this.toolStates.get(e).visible),a){let a;if("rapid"===t.type)a=s;else if(this.toolStates.has(e)){const t=this.toolStates.get(e).color;a=this.hexToRgb(t)}else a=i[e%i.length];const r=t.start.x+(t.end.x-t.start.x)*this.segmentProgress,h=t.start.y+(t.end.y-t.start.y)*this.segmentProgress,c=t.start.z+(t.end.z-t.start.z)*this.segmentProgress;n.push(t.start.x,t.start.y,t.start.z),o.push(...a),n.push(r,h,c),o.push(...a)}}}this.vertexCount=n.length/3,t.bindBuffer(t.ARRAY_BUFFER,this.buffers.position),t.bufferData(t.ARRAY_BUFFER,new Float32Array(n),t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,this.buffers.color),t.bufferData(t.ARRAY_BUFFER,new Float32Array(o),t.STATIC_DRAW)}hexToRgb(t){const e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return e?[parseInt(e[1],16)/255,parseInt(e[2],16)/255,parseInt(e[3],16)/255]:[1,1,1]}render(){if(!this.gl)return void console.error("No WebGL context");this.resizeCanvas();const t=this.gl;if("dark"===document.documentElement.getAttribute("data-theme")?t.clearColor(.15,.15,.15,1):t.clearColor(.98,.98,.98,1),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT),!this.vertexCount||0===this.vertexCount)return;t.useProgram(this.program);const e=this.canvas.width/this.canvas.height,s=this.camera.getMVPMatrix(e);t.uniformMatrix4fv(this.locations.uMVP,!1,s),t.bindBuffer(t.ARRAY_BUFFER,this.buffers.position),t.vertexAttribPointer(this.locations.aPosition,3,t.FLOAT,!1,0,0),t.enableVertexAttribArray(this.locations.aPosition),t.bindBuffer(t.ARRAY_BUFFER,this.buffers.color),t.vertexAttribPointer(this.locations.aColor,3,t.FLOAT,!1,0,0),t.enableVertexAttribArray(this.locations.aColor),t.drawArrays(t.LINES,0,this.vertexCount),this.drawGrid(s),this.drawAxes(s),this.drawCurrentPositionMarker(s),this.drawGridLabels(s)}drawGrid(t){const e=this.gl,s=document.getElementById("grid-enabled")?.checked;if(!s)return;const i=parseFloat(document.getElementById("grid-width")?.value||1e3),n=parseFloat(document.getElementById("grid-height")?.value||600);if(i<=0||n<=0)return;const o=document.documentElement.getAttribute("data-theme"),a="dark"===o?[.3,.3,.3]:[.85,.85,.85],r="dark"===o?[.5,.5,.5]:[.7,.7,.7],h="dark"===o?[.7,.7,.7]:[.5,.5,.5],c=[],l=[];for(let t=0;t<=i;t+=10)t%100!=0&&(c.push(t,0,0,t,n,0),l.push(...a,...a));for(let t=0;t<=n;t+=10)t%100!=0&&(c.push(0,t,0,i,t,0),l.push(...a,...a));for(let t=0;t<=i;t+=100)c.push(t,0,0,t,n,0),l.push(...r,...r);for(let t=0;t<=n;t+=100)c.push(0,t,0,i,t,0),l.push(...r,...r);c.push(0,0,0,i,0,0,i,0,0,i,n,0,i,n,0,0,n,0,0,n,0,0,0,0);for(let t=0;t<8;t++)l.push(...h);const d=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,d),e.bufferData(e.ARRAY_BUFFER,new Float32Array(c),e.STATIC_DRAW),e.vertexAttribPointer(this.locations.aPosition,3,e.FLOAT,!1,0,0);const u=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,u),e.bufferData(e.ARRAY_BUFFER,new Float32Array(l),e.STATIC_DRAW),e.vertexAttribPointer(this.locations.aColor,3,e.FLOAT,!1,0,0),e.drawArrays(e.LINES,0,c.length/3),e.deleteBuffer(d),e.deleteBuffer(u)}drawAxes(t){const e=this.gl;if(!this.bounds)return;const s=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,s),e.bufferData(e.ARRAY_BUFFER,new Float32Array([0,0,0,100,0,0,0,0,0,0,100,0,0,0,0,0,0,100]),e.STATIC_DRAW),e.vertexAttribPointer(this.locations.aPosition,3,e.FLOAT,!1,0,0);const i=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,i),e.bufferData(e.ARRAY_BUFFER,new Float32Array([1,0,0,1,0,0,0,1,0,0,1,0,0,0,1,0,0,1]),e.STATIC_DRAW),e.vertexAttribPointer(this.locations.aColor,3,e.FLOAT,!1,0,0),e.drawArrays(e.LINES,0,6),e.deleteBuffer(s),e.deleteBuffer(i)}drawCurrentPositionMarker(t){if(this.maxSegmentIndex>=this.segments.length||this.maxSegmentIndex===1/0)return;const e=this.segments[this.maxSegmentIndex];if(!e)return;const s=this.gl,i=this.segmentProgress,n=e.start.x+(e.end.x-e.start.x)*i,o=e.start.y+(e.end.y-e.start.y)*i,a=e.start.z+(e.end.z-e.start.z)*i,r=[],h=[],c=16;for(let t=0;t<=c;t++){const e=t*Math.PI/c,s=Math.sin(e),i=Math.cos(e);for(let t=0;t<=c;t++){const e=2*t*Math.PI/c,l=Math.sin(e),d=Math.cos(e)*s,u=l*s,g=i,m=n+1.5*d,f=o+1.5*u,p=a+1.5*g;r.push(m,f,p),h.push(d,u,g)}}const l=[];for(let t=0;t<c;t++)for(let e=0;e<c;e++){const s=17*t+e,i=s+c+1;l.push(s,i,s+1),l.push(i,i+1,s+1)}if(!this.sphereProgram){const t="\n attribute vec3 aPosition;\n attribute vec3 aNormal;\n uniform mat4 uMVP;\n varying vec3 vNormal;\n \n void main() {\n gl_Position = uMVP * vec4(aPosition, 1.0);\n vNormal = aNormal;\n }\n ",e="\n precision mediump float;\n varying vec3 vNormal;\n \n void main() {\n vec3 lightDir = normalize(vec3(0.5, 0.3, 1.0));\n float diffuse = max(dot(vNormal, lightDir), 0.0);\n float ambient = 0.3;\n float lighting = ambient + diffuse * 0.7;\n \n vec3 color = vec3(1.0, 0.0, 0.0) * lighting;\n gl_FragColor = vec4(color, 1.0);\n }\n ",i=this.compileShader(s.VERTEX_SHADER,t),n=this.compileShader(s.FRAGMENT_SHADER,e);this.sphereProgram=s.createProgram(),s.attachShader(this.sphereProgram,i),s.attachShader(this.sphereProgram,n),s.linkProgram(this.sphereProgram),this.sphereLocations={aPosition:s.getAttribLocation(this.sphereProgram,"aPosition"),aNormal:s.getAttribLocation(this.sphereProgram,"aNormal"),uMVP:s.getUniformLocation(this.sphereProgram,"uMVP")}}s.useProgram(this.sphereProgram),s.uniformMatrix4fv(this.sphereLocations.uMVP,!1,t);const d=s.createBuffer();s.bindBuffer(s.ARRAY_BUFFER,d),s.bufferData(s.ARRAY_BUFFER,new Float32Array(r),s.STATIC_DRAW),s.vertexAttribPointer(this.sphereLocations.aPosition,3,s.FLOAT,!1,0,0),s.enableVertexAttribArray(this.sphereLocations.aPosition);const u=s.createBuffer();s.bindBuffer(s.ARRAY_BUFFER,u),s.bufferData(s.ARRAY_BUFFER,new Float32Array(h),s.STATIC_DRAW),s.vertexAttribPointer(this.sphereLocations.aNormal,3,s.FLOAT,!1,0,0),s.enableVertexAttribArray(this.sphereLocations.aNormal);const g=s.createBuffer();s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,g),s.bufferData(s.ELEMENT_ARRAY_BUFFER,new Uint16Array(l),s.STATIC_DRAW),s.drawElements(s.TRIANGLES,l.length,s.UNSIGNED_SHORT,0),s.deleteBuffer(d),s.deleteBuffer(u),s.deleteBuffer(g)}drawGridLabels(t){if(!this.overlayCtx)return;const e=this.overlayCtx,s=document.getElementById("grid-enabled")?.checked;if(!s)return;const i=parseFloat(document.getElementById("grid-width")?.value||1e3),n=parseFloat(document.getElementById("grid-height")?.value||600);if(i<=0||n<=0)return;e.clearRect(0,0,this.overlayCanvas.width,this.overlayCanvas.height);const o=document.documentElement.getAttribute("data-theme");e.fillStyle="dark"===o?"#aaa":"#555",e.font="11px monospace",e.textAlign="center",e.textBaseline="middle";const a=(e,s,i)=>{const n=[e,s,i,1],o=[0,0,0,0];for(let e=0;e<4;e++)for(let s=0;s<4;s++)o[e]+=t[4*s+e]*n[s];const a=o[3],r=o[0]/a,h=o[1]/a;return{x:.5*(r+1)*this.overlayCanvas.width,y:.5*(1-h)*this.overlayCanvas.height,visible:a>0}};for(let t=0;t<=i;t+=100){const s=a(t,0,0);s.visible&&s.x>=0&&s.x<=this.overlayCanvas.width&&s.y>=0&&s.y<=this.overlayCanvas.height&&e.fillText(t.toString(),s.x,s.y+15)}for(let t=0;t<=n;t+=100){const s=a(0,t,0);s.visible&&s.x>=0&&s.x<=this.overlayCanvas.width&&s.y>=0&&s.y<=this.overlayCanvas.height&&e.fillText(t.toString(),s.x-20,s.y)}}destroy(){if(!this.gl)return;const t=this.gl;t.deleteBuffer(this.buffers.position),t.deleteBuffer(this.buffers.color),t.deleteProgram(this.program)}}class Animator{constructor(){this.segments=[],this.currentIndex=0,this.segmentProgress=0,this.isPlaying=!1,this.speed=1,this.lastTime=0,this.accumulatedTime=0,this.estimatedTotalTime=0,this.toolTimes=new Map,this.rapidSpeed=3e3,this.maxRateX=3e3,this.maxRateY=3e3,this.maxRateZ=2e3,this.accelX=200,this.accelY=200,this.accelZ=80,this.manualToolChangeTime=30,this.autoToolChangeTime=10,this.onUpdate=null}setMotionParameters(t){void 0!==t.accelX&&(this.accelX=t.accelX),void 0!==t.accelY&&(this.accelY=t.accelY),void 0!==t.accelZ&&(this.accelZ=t.accelZ),void 0!==t.maxRateX&&(this.maxRateX=t.maxRateX),void 0!==t.maxRateY&&(this.maxRateY=t.maxRateY),void 0!==t.maxRateZ&&(this.maxRateZ=t.maxRateZ),console.log("[Animator] Motion parameters updated:",{accel:{X:this.accelX,Y:this.accelY,Z:this.accelZ},maxRate:{X:this.maxRateX,Y:this.maxRateY,Z:this.maxRateZ}})}setSegments(t){this.segments=t,this.currentIndex=0,this.segmentProgress=0,this.accumulatedTime=0,this.calculateTotalTime(),this.calculateDistances()}calculateDistances(){this.segmentDistances=[];let t=0;for(let e=0;e<this.segments.length;e++){const s=this.segments[e];if("cut"===s.type){const e=s.end.x-s.start.x,i=s.end.y-s.start.y,n=s.end.z-s.start.z;t+=Math.sqrt(e*e+i*i+n*n)}this.segmentDistances.push(t)}this.totalDistance=t}calculateTotalTime(){this.estimatedTotalTime=0,this.toolTimes.clear();for(let t=0;t<this.segments.length;t++){const e=this.segments[t],s=t>0?this.segments[t-1]:null,i=t<this.segments.length-1?this.segments[t+1]:null;let n=0;if("M0"===e.toolChangeType?n+=this.manualToolChangeTime:"M6"===e.toolChangeType&&(n+=this.autoToolChangeTime),"cut"===e.type&&e.feedRate>0){const t=e.feedRate,o=s&&"cut"===s.type?s.feedRate:0,a=i&&"cut"===i.type?i.feedRate:0,r=this.calculateJunctionVelocity(s,e,o,t),h=this.calculateJunctionVelocity(e,i,t,a);n+=this.calculateMoveTime(e,t,r,h)}else if("rapid"===e.type){const t=e.end.x-e.start.x,o=e.end.y-e.start.y,a=e.end.z-e.start.z,r=Math.sqrt(t*t+o*o+a*a);if(r>0){let h=1/0;if(Math.abs(t)>.001){const e=r/(Math.abs(t)/(this.maxRateX/60))*60;h=Math.min(h,e)}if(Math.abs(o)>.001){const t=r/(Math.abs(o)/(this.maxRateY/60))*60;h=Math.min(h,t)}if(Math.abs(a)>.001){const t=r/(Math.abs(a)/(this.maxRateZ/60))*60;h=Math.min(h,t)}h===1/0&&(h=this.rapidSpeed);const c=s&&"rapid"===s.type,l=i&&"rapid"===i.type,d=c?this.calculateJunctionVelocity(s,e,h,h):0,u=l?this.calculateJunctionVelocity(e,i,h,h):0;n+=this.calculateMoveTime(e,h,d,u)}}if(this.estimatedTotalTime+=n,"cut"===e.type){const t=e.tool||1,s=this.toolTimes.get(t)||0;this.toolTimes.set(t,s+n)}}}calculateMoveTime(t,e,s=0,i=0){const n=t.end.x-t.start.x,o=t.end.y-t.start.y,a=t.end.z-t.start.z,r=Math.sqrt(n*n+o*o+a*a);if(0===r)return 0;const h=e/60;let c=1/0;if(Math.abs(n)>.001){const t=this.accelX;c=Math.min(c,t)}if(Math.abs(o)>.001){const t=this.accelY;c=Math.min(c,t)}if(Math.abs(a)>.001){const t=this.accelZ;c=Math.min(c,t)}c===1/0&&(c=this.accelX);const l=(h*h-(s=Math.min(s,h))*s)/(2*c)+(h*h-(i=Math.min(i,h))*i)/(2*c);if(l>=r){const t=(s*s+i*i)/2+c*r,e=Math.sqrt(Math.max(0,t));return(e-s)/c+(e-i)/c}return(h-s)/c+(r-l)/h+(h-i)/c}calculateJunctionVelocity(t,e,s,i){if(!t||!e)return 0;if(t.tool!==e.tool||t.type!==e.type)return 0;const n=t.end.x-e.start.x,o=t.end.y-e.start.y,a=t.end.z-e.start.z;if(n*n+o*o+a*a>=1e-6)return 0;const r=t.end.x-t.start.x,h=t.end.y-t.start.y,c=t.end.z-t.start.z,l=r*r+h*h+c*c,d=e.end.x-e.start.x,u=e.end.y-e.start.y,g=e.end.z-e.start.z,m=d*d+u*u+g*g;if(0===l||0===m)return 0;const f=Math.sqrt(l),p=Math.sqrt(m),x=r/f*(d/p)+h/f*(u/p)+c/f*(g/p);if(x>.999)return Math.min(s,i)/60;const y=(1+x)/2;return Math.min(s,i)/60*y}formatDuration(t){if(0===t)return"-";const e=Math.floor(t),s=Math.floor(e/3600),i=Math.floor(e%3600/60),n=e%60;return s>0?`${s}h ${i}m ${n}s`:i>0?`${i}m ${n}s`:`${n}s`}getFormattedTime(){return this.formatDuration(this.estimatedTotalTime)}getToolTime(t){const e=this.toolTimes.get(t)||0;return this.formatDuration(e)}getToolTimes(){return this.toolTimes}play(){0!==this.segments.length&&(this.isPlaying=!0,this.lastTime=performance.now(),this.animate())}pause(){this.isPlaying=!1}reset(){this.currentIndex=0,this.accumulatedTime=0,this.isPlaying=!1,this.onUpdate&&this.onUpdate(this.currentIndex)}setSpeed(t){this.speed=Math.max(.1,Math.min(10,t))}static sliderToSpeed(t){return 0===t?1:t>0?1+t/10*9:1+t/10*.9}stepNext(){this.currentIndex<this.segments.length&&(this.currentIndex++,this.onUpdate&&this.onUpdate(this.currentIndex))}stepPrev(){this.currentIndex>0&&(this.currentIndex--,this.onUpdate&&this.onUpdate(this.currentIndex))}setCurrentLine(t){const e=Math.max(0,Math.min(t,this.segments.length));e!==this.currentIndex&&(this.currentIndex=e,this.isPlaying=!1,this.onUpdate&&this.onUpdate(this.currentIndex))}animate(){if(!this.isPlaying)return;const t=performance.now(),e=(t-this.lastTime)/1e3;if(this.lastTime=t,this.totalDistance>0){const t=100*this.speed*e;this.accumulatedTime+=t;const s=this.accumulatedTime;let i=0,n=0,o=this.segmentDistances.length-1;for(;n<o;){const t=Math.floor((n+o)/2);this.segmentDistances[t]<s?n=t+1:o=t}if(i=n,i<this.segments.length){const t=this.segments[i],e=i>0?this.segmentDistances[i-1]:0,n=this.segmentDistances[i]-e;if("cut"===t.type&&n>0){const t=s-e;this.segmentProgress=Math.min(1,Math.max(0,t/n))}else this.segmentProgress=1}else this.segmentProgress=1;if(this.currentIndex,this.currentIndex=i,this.onUpdate&&this.onUpdate(this.currentIndex,this.segmentProgress),this.accumulatedTime>=this.totalDistance)return this.currentIndex=this.segments.length,this.segmentProgress=1,this.isPlaying=!1,void(this.onUpdate&&this.onUpdate(this.currentIndex,1))}else if(this.estimatedTotalTime>0){this.accumulatedTime+=e*this.speed;const t=this.accumulatedTime/this.estimatedTotalTime,s=Math.floor(t*this.segments.length);if(s!==this.currentIndex&&s<=this.segments.length&&(this.currentIndex=s,this.segmentProgress=1,this.onUpdate&&this.onUpdate(this.currentIndex,1)),this.currentIndex>=this.segments.length)return this.currentIndex=this.segments.length,this.segmentProgress=1,this.isPlaying=!1,void(this.onUpdate&&this.onUpdate(this.currentIndex,1))}else{const t=100*this.speed*e;if(this.currentIndex+=t,this.segmentProgress=1,this.onUpdate&&this.onUpdate(Math.floor(this.currentIndex),1),this.currentIndex>=this.segments.length)return this.currentIndex=this.segments.length,this.segmentProgress=1,this.isPlaying=!1,void(this.onUpdate&&this.onUpdate(this.currentIndex,1))}requestAnimationFrame(()=>this.animate())}getProgress(){return 0===this.segments.length?0:this.currentIndex/this.segments.length*100}getCurrentIndex(){return Math.floor(this.currentIndex)}getTotalSegments(){return this.segments.length}getIsPlaying(){return this.isPlaying}}class Controller{constructor(){this.parser=new GCodeParser,this.camera=new Camera,this.animator=new Animator,this.canvas2d=document.getElementById("canvas2d"),this.canvas3d=document.getElementById("canvas3d"),this.canvas3dOverlay=document.getElementById("canvas3d-overlay"),this.renderer2d=new Renderer2D(this.canvas2d,this.camera),this.renderer3d=new Renderer3D(this.canvas3d,this.camera,this.canvas3dOverlay),this.currentView="2d",this.segments=[],this.bounds=null,this.isDragging=!1,this.lastMouseX=0,this.lastMouseY=0,this.isShiftPressed=!1,this.tools=new Map,this.toolColors=["#00ccff","#00ff88","#ff4dff","#ffff00","#ff8800","#8888ff","#ff0088","#00ffff"],this.rapidMovesVisible=!0,this.rapidMoveColor="#999999",this.spaceMouseConnected=!1,this.spaceMouseIndex=-1,this.touches=[],this.lastPinchDistance=0,this.lastTouchCenter=null,this.setupEventListeners(),this.setupAnimator(),this.setupSpaceMouse(),this.startRenderLoop()}setupSpaceMouse(){window.addEventListener("gamepadconnected",t=>{const e=t.gamepad;(e.id.toLowerCase().includes("3dconnexion")||e.id.toLowerCase().includes("spacemouse")||e.id.toLowerCase().includes("space"))&&(this.spaceMouseConnected=!0,this.spaceMouseIndex=e.index,console.log("SpaceMouse connected:",e.id))}),window.addEventListener("gamepaddisconnected",t=>{t.gamepad.index===this.spaceMouseIndex&&(this.spaceMouseConnected=!1,this.spaceMouseIndex=-1,console.log("SpaceMouse disconnected"))})}pollSpaceMouse(){if(!this.spaceMouseConnected||"3d"!==this.currentView)return;const t=navigator.getGamepads();if(!t||!t[this.spaceMouseIndex])return;const e=t[this.spaceMouseIndex],s=.05,i=[];for(let t=0;t<e.axes.length;t++)Math.abs(e.axes[t])>s&&i.push(`axis${t}=${e.axes[t].toFixed(2)}`);if(i.length>0&&console.log("Active axes:",i.join(", ")),e.axes.length>=3){const t=Math.abs(e.axes[0])>s?e.axes[0]:0,i=Math.abs(e.axes[2])>s?e.axes[2]:0;0===t&&0===i||this.camera.pan3D(.5*-t,.5*-i)}if(e.axes.length>=2){const t=Math.abs(e.axes[1])>s?e.axes[1]:0;0!==t&&(this.camera.zoom3D(.05*t),this.updateZoomSlider())}if(e.axes.length>=5){const t=Math.abs(e.axes[3])>s?e.axes[3]:0,i=Math.abs(e.axes[4])>s?e.axes[4]:0;0===t&&0===i||this.camera.rotate(15*i,15*-t)}e.axes.length>=6&&Math.abs(e.axes[5])>s&&e.axes[5]}setupEventListeners(){let t;document.querySelectorAll(".mobile-tab-button").forEach(t=>{t.addEventListener("click",()=>{const e=t.getAttribute("data-tab");this.switchMobileTab(e)})}),window.addEventListener("resize",()=>{clearTimeout(t),t=setTimeout(()=>{if(this.renderer2d.resizeCanvas(),this.renderer3d.resizeCanvas(),window.innerWidth>968)document.querySelectorAll(".mobile-tab-content").forEach(t=>{t.classList.add("active")});else{const t=document.querySelector(".mobile-tab-button.active");if(t){const e=t.getAttribute("data-tab");this.switchMobileTab(e)}}},100)});const e=document.getElementById("upload-zone"),s=document.getElementById("file-input");e&&s&&(e.addEventListener("click",()=>s.click()),e.addEventListener("dragover",t=>{t.preventDefault(),e.classList.add("drag-over")}),e.addEventListener("dragleave",()=>{e.classList.remove("drag-over")}),e.addEventListener("drop",t=>{t.preventDefault(),e.classList.remove("drag-over"),t.dataTransfer.files.length>0&&this.loadFile(t.dataTransfer.files[0])}),s.addEventListener("change",t=>{t.target.files.length>0&&this.loadFile(t.target.files[0])}));const i=document.getElementById("btn-toggle-view");i&&i.addEventListener("click",()=>{this.toggleView()});const n=document.getElementById("btn-reset-view");n&&n.addEventListener("click",()=>{this.segments.length>0&&(this.camera.fitToBounds(this.bounds,.1,this.canvas2d.width,this.canvas2d.height),this.updateZoomSlider())});const o=document.getElementById("btn-play");o&&o.addEventListener("click",()=>{this.togglePlayback()});const a=document.getElementById("btn-reset");a&&a.addEventListener("click",()=>{this.animator.reset()});const r=document.getElementById("btn-next");r&&r.addEventListener("click",()=>{this.animator.stepNext()});const h=document.getElementById("btn-prev");h&&h.addEventListener("click",()=>{this.animator.stepPrev()});const c=document.getElementById("speed-slider"),l=document.getElementById("speed-label");c&&l&&c.addEventListener("input",t=>{const e=Animator.sliderToSpeed(parseFloat(t.target.value));this.animator.setSpeed(e),l.textContent=e.toFixed(1)+"x"});const d=document.getElementById("line-slider");d&&d.addEventListener("input",t=>{const e=parseInt(t.target.value);this.animator.setCurrentLine(e)});const u=document.getElementById("layer-slider-min"),g=document.getElementById("layer-slider-max"),m=document.getElementById("layer-min-value"),f=document.getElementById("layer-max-value");u&&g&&(u.min=0,u.max=100,u.value=0,g.min=0,g.max=100,g.value=100,m&&(m.textContent="0.0"),f&&(f.textContent="100.0"),this.updateRangeHighlight(),u.addEventListener("input",()=>{const t=parseFloat(u.value),e=parseFloat(g.value);t>e&&(u.value=e),m&&(m.textContent=u.value),this.updateRangeHighlight(),this.updateLayerFilter()}),g.addEventListener("input",()=>{const t=parseFloat(u.value);parseFloat(g.value)<t&&(g.value=t),f&&(f.textContent=g.value),this.updateRangeHighlight(),this.updateLayerFilter()}));const p=document.getElementById("zoom-slider"),x=document.getElementById("zoom-value");p&&x&&p.addEventListener("input",t=>{const e=parseFloat(t.target.value);if("2d"===this.currentView){const t=e*this.camera.initialZoom2d;this.setZoom(t)}else{const t=this.camera.initialOrthoScale/e;this.camera.orthoScale=t,this.render()}x.textContent=Math.round(100*e)+"%"});const y=document.getElementById("theme-light"),v=document.getElementById("theme-dark");if(y&&v){const t=localStorage.getItem("theme")||"light";document.documentElement.setAttribute("data-theme",t),y.addEventListener("click",()=>{document.documentElement.setAttribute("data-theme","light"),localStorage.setItem("theme","light"),this.render()}),v.addEventListener("click",()=>{document.documentElement.setAttribute("data-theme","dark"),localStorage.setItem("theme","dark"),this.render()})}const b=document.getElementById("grid-enabled");b&&b.addEventListener("change",()=>{});const E=document.getElementById("grid-width");E&&E.addEventListener("input",()=>{});const C=document.getElementById("grid-height");C&&C.addEventListener("input",()=>{});const M=document.getElementById("rapid-moves-visible"),I=document.getElementById("rapid-move-color");M&&M.addEventListener("change",()=>{this.rapidMovesVisible=M.checked,this.updateRenderers()}),I&&I.addEventListener("input",()=>{this.rapidMoveColor=I.value,this.updateRenderers()}),this.setupCanvasEvents(),window.addEventListener("keydown",t=>{"Shift"===t.key&&(this.isShiftPressed=!0)}),window.addEventListener("keyup",t=>{"Shift"===t.key&&(this.isShiftPressed=!1)})}setupCanvasEvents(){const t=this.canvas2d,e=this.canvas3d,s=t=>{this.isDragging=!0,this.dragButton=t.button,this.lastMouseX=t.clientX,this.lastMouseY=t.clientY,2===t.button&&t.preventDefault()},i=e=>{if(this.isDragging){const t=e.clientX-this.lastMouseX,s=e.clientY-this.lastMouseY;"2d"===this.currentView?this.camera.pan2D(t,s):2===this.dragButton?this.camera.pan3D(t,s):this.camera.rotate(t,s),this.lastMouseX=e.clientX,this.lastMouseY=e.clientY}else if("2d"===this.currentView){const s=t.getBoundingClientRect(),i=e.clientX-s.left,n=e.clientY-s.top,o=this.renderer2d.canvasToWorld(i,n);this.updateCoordinateDisplay(o.x,o.y,0)}},n=()=>{this.isDragging=!1},o=e=>{if(e.preventDefault(),"2d"===this.currentView){const s=t.getBoundingClientRect(),i=e.clientX-s.left,n=e.clientY-s.top;this.camera.zoom2D(e.deltaY,i,n,t.width,t.height)}else this.camera.zoom3D(e.deltaY);this.updateZoomSlider()},a=()=>{this.bounds&&this.camera.fitToBounds(this.bounds)},r=t=>{t.preventDefault()};[t,e].forEach(t=>{t.addEventListener("mousedown",s),t.addEventListener("mousemove",i),t.addEventListener("mouseup",n),t.addEventListener("mouseleave",n),t.addEventListener("wheel",o,{passive:!1}),t.addEventListener("dblclick",a),t.addEventListener("contextmenu",r)});const h=t=>{t.preventDefault(),this.touches=Array.from(t.touches),1===this.touches.length?(this.isDragging=!0,this.lastMouseX=this.touches[0].clientX,this.lastMouseY=this.touches[0].clientY):2===this.touches.length&&(this.lastPinchDistance=this.getTouchDistance(this.touches[0],this.touches[1]),this.lastTouchCenter=this.getTouchCenter(this.touches[0],this.touches[1]))},c=e=>{if(e.preventDefault(),this.touches=Array.from(e.touches),1===this.touches.length&&this.isDragging){const t=this.touches[0].clientX-this.lastMouseX,e=this.touches[0].clientY-this.lastMouseY;"2d"===this.currentView?this.camera.pan2D(t,e):this.camera.rotate(1.5*t,1.5*e),this.lastMouseX=this.touches[0].clientX,this.lastMouseY=this.touches[0].clientY}else if(2===this.touches.length){const e=this.getTouchDistance(this.touches[0],this.touches[1]),s=this.getTouchCenter(this.touches[0],this.touches[1]),i=e-this.lastPinchDistance;if("2d"===this.currentView){if(Math.abs(i)<100&&Math.abs(i)>.5){const e=t.getBoundingClientRect(),n=s.x-e.left,o=s.y-e.top;this.renderer2d.canvasToWorld(n,o),this.camera.zoom2D(-i,n,o,e.width,e.height,!0)}}else{if(this.lastTouchCenter){const t=s.x-this.lastTouchCenter.x,e=s.y-this.lastTouchCenter.y;Math.sqrt(t*t+e*e)>2&&this.camera.pan3D(2*t,2*e)}Math.abs(i)>5&&this.camera.zoom3D(.003*-i)}this.lastPinchDistance=e,this.lastTouchCenter=s}},l=()=>{this.isDragging=!1,this.touches=[],this.lastTouchCenter=null};[t,e].forEach(t=>{t.addEventListener("touchstart",h,{passive:!1}),t.addEventListener("touchmove",c,{passive:!1}),t.addEventListener("touchend",l,{passive:!1})})}getTouchDistance(t,e){const s=e.clientX-t.clientX,i=e.clientY-t.clientY;return Math.sqrt(s*s+i*i)}getTouchCenter(t,e){return{x:(t.clientX+e.clientX)/2,y:(t.clientY+e.clientY)/2}}setupAnimator(){this.animator.onUpdate=(t,e=1)=>{if(this.renderer2d.setMaxSegmentIndex(t,e),this.renderer3d.setMaxSegmentIndex(t,e),document.getElementById("current-line").textContent=t,document.getElementById("line-slider").value=t,t<this.segments.length){const e=this.segments[t];this.currentPosition={x:e.x1,y:e.y1,z:e.z1},this.highlightGCodeLine(e.lineNum),document.getElementById("current-file-line").textContent=e.lineNum||"-";const s=e.tool||0;this.currentActiveTool!==s&&(this.currentActiveTool=s,this.updateActiveToolHighlight())}else document.getElementById("current-file-line").textContent="-";document.getElementById("btn-play").textContent=this.animator.getIsPlaying()?"Pause":"Play"}}async loadFile(t){const e=document.getElementById("progress-bar"),s=document.getElementById("progress-fill");e.classList.remove("hidden"),s.style.width="0%";try{const i=await t.text();this.gcodeText=i;const n=await this.parser.parseFile(t,t=>{s.style.width=t+"%"});this.segments=n,this.bounds=this.parser.getBounds(),this.detectTools(n),this.renderer2d.setSegments(n,this.bounds),this.renderer3d.setSegments(n,this.bounds),this.updateRenderers(),this.animator.setSegments(n),this.camera.fitToBounds(this.bounds,.1,this.canvas2d.width,this.canvas2d.height),this.updateStatistics(),this.displayGCode(i),this.updateToolPanel(),this.initializeLayerSliders();const o=document.getElementById("gcode-panel");o.style.visibility="visible",o.style.position="static",document.getElementById("animation-panel").style.display="block",document.getElementById("tool-panel").style.display="block";const a=document.getElementById("rapid-moves-panel");a&&(a.style.display="block"),document.getElementById("btn-reset-view").disabled=!1;const r=document.querySelector(".left-sidebar");r&&r.classList.remove("gcode-hidden");const h=document.getElementById("gcode-welcome");h&&(h.style.display="none");const c=document.getElementById("line-slider");c.max=n.length,c.value=0,document.getElementById("total-lines").textContent=n.length,setTimeout(()=>{e.classList.add("hidden")},500)}catch(t){console.error("Error loading file:",t),alert("Error loading GCode file. Please check the console for details."),e.classList.add("hidden")}}async loadGCodeFromString(t,e=""){const s=document.getElementById(`${e}progress-bar`),i=document.getElementById(`${e}progress-fill`),n=t.split("\n").filter(t=>/Y\d{5,}/.test(t));n.length>0?console.error(`CONTROLLER ERROR: String has ${n.length} bad lines:`,n.slice(0,2)):console.log("‚úì Controller OK: String is clean in loadGCodeFromString"),s&&(s.classList.remove("hidden"),i.style.width="0%");try{this.gcodeText=t;const n=await this.parser.parseString(t,t=>{i&&(i.style.width=t+"%")});this.segments=n,this.bounds=this.parser.getBounds(),this.detectTools(n),this.renderer2d.setSegments(n,this.bounds),this.renderer3d.setSegments(n,this.bounds),this.updateRenderers(),this.animator.setSegments(n),this.camera.fitToBounds(this.bounds,.1,this.canvas2d.width,this.canvas2d.height),this.updateStatistics(e),this.displayGCode(t,e),this.updateToolPanel(e);const o=document.getElementById(`${e}gcode-panel`);o&&(o.style.visibility="visible",o.style.position="static");const a=document.getElementById(`${e}animation-panel`);a&&(a.style.display="block");const r=document.getElementById(`${e}tool-panel`);r&&(r.style.display="block");const h=document.getElementById(`${e}rapid-moves-panel`);h&&(h.style.display="block");const c=document.getElementById(`${e}btn-reset-view`);c&&(c.disabled=!1);const l=document.querySelector(e?`.${e}left-sidebar`:".left-sidebar");l&&l.classList.remove("gcode-hidden");const d=document.getElementById(`${e}gcode-welcome`);d&&(d.style.display="none");const u=document.getElementById(`${e}line-slider`);u&&(u.max=n.length,u.value=0);const g=document.getElementById(`${e}total-lines`);g&&(g.textContent=n.length),this.is3DView?this.renderer3d.render():this.renderer2d.render(),s&&setTimeout(()=>{s.classList.add("hidden")},500)}catch(t){console.error("Error loading GCode:",t),alert("Error parsing GCode. Please check the console for details."),s&&s.classList.add("hidden")}}detectTools(t){const e=new Set;for(const s of t)"rapid"!==s.type&&e.add(s.tool||1);const s=this.parser.getToolNames(),i=this.parser.getToolColors(),n=this.parser.usingInlineToolFormat;this.tools.clear();const o=Array.from(e).sort((t,e)=>t-e);for(const t of o){const e=n?t:t-1,o=i[e],a=t%this.toolColors.length,r=this.toolColors[a];this.tools.set(t,{visible:!0,color:o||r,name:s[e]||`Tool ${t}`})}}updateToolPanel(t=""){const e=document.getElementById(`${t}tool-list`);if(e)if(e.innerHTML="",0!==this.tools.size)for(const[t,s]of this.tools){const i=document.createElement("div");i.className="tool-item",i.setAttribute("data-tool",t),i.style.cssText="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; padding: 8px; background: var(--canvas-bg); border-radius: 4px; transition: border 0.2s, box-shadow 0.2s;";const n=document.createElement("input");n.type="checkbox",n.checked=s.visible,n.onchange=()=>{s.visible=n.checked,this.updateRenderers()};const o=document.createElement("input");o.type="color",o.value=s.color,o.style.cssText="width: 32px; height: 24px; border: none; cursor: pointer;",o.onchange=()=>{s.color=o.value,this.updateRenderers()};const a=document.createElement("div");a.style.cssText="flex: 1; display: flex; flex-direction: column; gap: 2px;";const r=document.createElement("span"),h=s.name?`Tool ${t} - ${s.name}`:`Tool ${t}`;r.textContent=h,r.style.cssText="font-size: 13px;";const c=document.createElement("span"),l=this.animator.getToolTime(t);c.textContent=`Est. Time: ${l}`,c.style.cssText="font-size: 11px; opacity: 0.7;",a.appendChild(r),a.appendChild(c),i.appendChild(n),i.appendChild(o),i.appendChild(a),e.appendChild(i)}else e.innerHTML='<div style="padding: 10px; opacity: 0.7; font-size: 12px;">No tools detected</div>'}updateActiveToolHighlight(){if(document.querySelectorAll(".tool-item").forEach(t=>{t.style.border="none",t.style.boxShadow="none"}),void 0!==this.currentActiveTool){const t=document.querySelector(`.tool-item[data-tool="${this.currentActiveTool}"]`);t&&(t.style.border="2px solid var(--cut-color)",t.style.boxShadow="0 0 8px rgba(0, 204, 255, 0.3)")}}updateRenderers(){this.renderer2d.setToolStates(this.tools),this.renderer3d.setToolStates(this.tools),this.renderer2d.setRapidMoveSettings(this.rapidMovesVisible,this.rapidMoveColor),this.renderer3d.setRapidMoveSettings(this.rapidMovesVisible,this.rapidMoveColor),this.renderer2d.updateBuffers(),this.renderer3d.updateBuffers()}updateStatistics(t=""){const e=document.getElementById(`${t}stat-lines`),s=document.getElementById(`${t}stat-time`),i=document.getElementById(`${t}stat-x`),n=document.getElementById(`${t}stat-y`),o=document.getElementById(`${t}stat-z`),a=document.getElementById(`${t}total-lines`),r=document.getElementById(`${t}current-line`),h=document.getElementById(`${t}layer-min`),c=document.getElementById(`${t}layer-max`);e&&(e.textContent=this.segments.length),s&&(s.textContent=this.animator.getFormattedTime()),i&&(i.textContent=`${this.bounds.minX.toFixed(1)} to ${this.bounds.maxX.toFixed(1)}`),n&&(n.textContent=`${this.bounds.minY.toFixed(1)} to ${this.bounds.maxY.toFixed(1)}`),o&&(o.textContent=`${this.bounds.minZ.toFixed(1)} to ${this.bounds.maxZ.toFixed(1)}`),a&&(a.textContent=this.segments.length),r&&(r.textContent="0"),h&&(h.placeholder=this.bounds.minZ.toFixed(1)),c&&(c.placeholder=this.bounds.maxZ.toFixed(1))}updateCoordinateDisplay(t,e,s){const i=document.getElementById("coordinates");i&&(i.textContent=`X: ${t.toFixed(2)} Y: ${e.toFixed(2)} Z: ${s.toFixed(2)}`)}displayGCode(t,e=""){const s=document.getElementById(`${e}gcode-container`);if(!s)return;const i=t.split("\n"),n=i.length;this.gcodeLines=i,this.gcodeLineHeight=17,this.gcodeCurrentHighlight=null;const o=document.getElementById(`${e}gcode-line-indicator`);o&&(o.textContent=`(${n} lines)`),s.innerHTML=`\n <div style="min-height: ${(n+10)*this.gcodeLineHeight}px; position: relative; width: max-content; min-width: 100%;">\n <div id="${e}gcode-viewport" style="position: absolute; top: 0; left: 0; will-change: transform;">\n <div style="display: flex;">\n <div class="gcode-line-numbers" id="${e}gcode-line-numbers"></div>\n <div class="gcode-code" id="${e}gcode-display"></div>\n </div>\n </div>\n </div>\n `;const a=document.getElementById(`${e}gcode-viewport`),r=document.getElementById(`${e}gcode-display`),h=document.getElementById(`${e}gcode-line-numbers`);let c=-1;const l=(t=!1)=>{const e=s.scrollTop;let o=s.clientHeight;o&&0!==o||(o=s.offsetHeight||.5*window.innerHeight);const l=Math.max(0,Math.floor(e/this.gcodeLineHeight)-50),d=Math.min(n,l+Math.ceil(o/this.gcodeLineHeight)+150);if(!t&&l===c)return;c=l,a.style.transform=`translateY(${l*this.gcodeLineHeight}px)`;const u=[];for(let t=l;t<d;t++){const e=this.gcodeCurrentHighlight===t+1?" highlight":"";u.push(`<div class="gcode-line${e}" data-line="${t+1}">${t+1}</div>`)}h.innerHTML=u.join("");const g=[];for(let t=l;t<d;t++){const e=this.gcodeCurrentHighlight===t+1?" highlight":"",s=this.syntaxHighlightGCode(i[t]);g.push(`<div class="gcode-line${e}" data-line="${t+1}">${s||"&nbsp;"}</div>`)}r.innerHTML=g.join("")};this.gcodeRenderVisibleLines=l;let d=!1;s.addEventListener("scroll",()=>{d||(requestAnimationFrame(()=>{l(),d=!1}),d=!0)},{passive:!0}),l(!0),requestAnimationFrame(()=>l(!0)),setTimeout(()=>l(!0),100),s.addEventListener("click",t=>{const e=t.target.closest(".gcode-line");if(!e)return;const s=parseInt(e.dataset.line);if(!s)return;const i=this.segments.findIndex(t=>t.lineNum>=s);-1!==i&&(this.animator.currentIndex=i,this.animator.onUpdate(i),"2d"===this.currentView?this.renderer2d.render():this.renderer3d.render(),this.highlightGCodeLine(s))})}syntaxHighlightGCode(t){let e=t,s=[];const i=t.indexOf(";"),n=t.indexOf("("),o=t.indexOf(")");return-1!==n&&-1!==o&&o>n?(s.push({text:t.substring(0,n),isComment:!1}),s.push({text:t.substring(n,o+1),isComment:!0}),s.push({text:t.substring(o+1),isComment:!1})):-1!==i?(s.push({text:t.substring(0,i),isComment:!1}),s.push({text:t.substring(i),isComment:!0})):s.push({text:t,isComment:!1}),e=s.map(t=>{if(t.isComment)return`<span class="gcode-comment">${this.escapeHtml(t.text)}</span>`;let e=t.text;return e=e.replace(/\$([A-Za-z0-9\/=]+)/g,'<span class="gcode-system">$$1</span>'),e=e.replace(/\b([GM])(\d+(\.\d+)?)/gi,(t,e,s)=>`<span class="${"G"===e.toUpperCase()?"gcode-g-code":"gcode-m-code"}">${e}${s}</span>`),e=e.replace(/\b(T)(\d+)/gi,'<span class="gcode-t-code">$1$2</span>'),e=e.replace(/\b(S)(\d+(\.\d+)?)/gi,'<span class="gcode-s-code">$1$2</span>'),e=e.replace(/([X])([-+]?\d+(\.\d+)?)/gi,'<span class="gcode-x-axis">$1$2</span>'),e=e.replace(/([Y])([-+]?\d+(\.\d+)?)/gi,'<span class="gcode-y-axis">$1$2</span>'),e=e.replace(/([Z])([-+]?\d+(\.\d+)?)/gi,'<span class="gcode-z-axis">$1$2</span>'),e=e.replace(/([ABCIJK])([-+]?\d+(\.\d+)?)/gi,'<span class="gcode-coordinate">$1$2</span>'),e=e.replace(/([F])(\d+(\.\d+)?)/gi,'<span class="gcode-f-code">$1$2</span>'),e}).join(""),e}escapeHtml(t){const e=document.createElement("div");return e.textContent=t,e.innerHTML}highlightGCodeLine(t){const e=document.getElementById("gcode-container");if(t<1||!e)return;this.gcodeCurrentHighlight=t;const s=e.scrollTop,i=e.clientHeight||600,n=(t-1)*this.gcodeLineHeight,o=n+this.gcodeLineHeight,a=.2*i;if(n>=s+a&&o<=s+i-a&&this.gcodeRenderVisibleLines)this.gcodeRenderVisibleLines(!0);else{const t=n-i/2+this.gcodeLineHeight/2;e.scrollTop=Math.max(0,t)}}updateRangeHighlight(){const t=document.getElementById("layer-slider-min"),e=document.getElementById("layer-slider-max"),s=document.getElementById("layer-range-highlight");if(!t||!e||!s)return;const i=parseFloat(t.min),n=parseFloat(t.max),o=(parseFloat(t.value)-i)/(n-i)*100,a=(parseFloat(e.value)-i)/(n-i)*100;s.style.left=o+"%",s.style.width=a-o+"%"}updateLayerFilter(){const t=document.getElementById("layer-slider-min"),e=document.getElementById("layer-slider-max"),s=t?parseFloat(t.value):-1/0,i=e?parseFloat(e.value):1/0;this.renderer2d.setLayerFilter(s,i),this.renderer3d.setLayerFilter(s,i)}initializeLayerSliders(){if(!this.bounds)return;const t=document.getElementById("layer-slider-min"),e=document.getElementById("layer-slider-max"),s=document.getElementById("layer-min-value"),i=document.getElementById("layer-max-value");if(!t||!e)return;const n=Math.floor(10*this.bounds.minZ)/10,o=Math.ceil(10*this.bounds.maxZ)/10;t.min=n,t.max=o,t.value=n,e.min=n,e.max=o,e.value=o,s&&(s.textContent=n.toFixed(1)),i&&(i.textContent=o.toFixed(1)),this.updateRangeHighlight()}setZoom(t){if("2d"===this.currentView)this.camera.zoom2d=t,this.camera.targetZoom2d=t;else{const e=100;this.camera.orthoScale=e/t}}toggleView(){"2d"===this.currentView?(this.currentView="3d",this.canvas2d.classList.add("hidden"),this.canvas3d.classList.remove("hidden"),this.canvas3dOverlay.classList.remove("hidden"),document.getElementById("btn-toggle-view").textContent="2D View"):(this.currentView="2d",this.canvas3d.classList.add("hidden"),this.canvas3dOverlay.classList.add("hidden"),this.canvas2d.classList.remove("hidden"),document.getElementById("btn-toggle-view").textContent="3D View"),this.updateZoomSlider()}updateZoomSlider(){const t=document.getElementById("zoom-slider"),e=document.getElementById("zoom-value");let s;s="2d"===this.currentView?this.camera.zoom2d/this.camera.initialZoom2d:this.camera.initialOrthoScale/this.camera.orthoScale,t.value=s,e.textContent=Math.round(100*s)+"%"}togglePlayback(){this.animator.getIsPlaying()?this.animator.pause():this.animator.play()}switchMobileTab(t){document.querySelectorAll(".mobile-tab-button").forEach(e=>{e.classList.toggle("active",e.getAttribute("data-tab")===t)}),document.querySelectorAll(".mobile-tab-content").forEach(e=>{e.classList.toggle("active",e.getAttribute("data-tab-content")===t)})}startRenderLoop(){const t=()=>{this.pollSpaceMouse(),this.camera.update(),"2d"===this.currentView?this.renderer2d.render():this.renderer3d.render(),requestAnimationFrame(t)};t()}}window.addEventListener("DOMContentLoaded",()=>{document.getElementById("text-to-gcode")||new Controller});class FontCreatorController{constructor(){this.canvas=null,this.ctx=null,this.font={},this.kerning=[],this.fontMetrics={unitsPerEm:1e3,ascent:800,descent:-200,capHeight:700,xHeight:500},this.currentChar=null,this.currentFontId=null,this.defaultCharArray="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789`~!@#$%^&*()-_=+[{]}\\|;:'\",<.>/? ‚Äò‚Äô‚Äú‚Äù‚Äî".split(""),this.charArray=[...this.defaultCharArray],this.strokes=[],this.showGuides=!0,this.guidePositions={ascent:800,capHeight:700,xHeight:500,baseline:0,descent:-200},this.currentStroke=null,this.isDrawing=!1,this.history=[],this.historyIndex=-1,this.generatedGCode="",this.gridSize=30,this.isDraggingLine=!1,this.dragLineType=null,this.dragStartX=0,this.dragLineStartValue=0}setupCanvas(){this.canvas=document.getElementById("drawing-canvas"),this.ctx=this.canvas.getContext("2d");const t=this.canvas.parentElement,e=t.clientWidth-40,s=t.clientHeight-40,i=Math.min(e,s,600);let n;this.canvas.width=i,this.canvas.height=i,this.canvas.style.width=i+"px",this.canvas.style.height=i+"px",this.gridSize=i/20,this.canvas.addEventListener("mousedown",t=>this.startDrawing(t)),this.canvas.addEventListener("mousemove",t=>this.draw(t)),this.canvas.addEventListener("mouseup",()=>this.stopDrawing()),this.canvas.addEventListener("mouseleave",()=>this.stopDrawing()),this.canvas.addEventListener("touchstart",t=>{t.preventDefault(),this.startDrawing(t.touches[0])},{passive:!1}),this.canvas.addEventListener("touchmove",t=>{t.preventDefault(),this.draw(t.touches[0])},{passive:!1}),this.canvas.addEventListener("touchend",t=>{t.preventDefault(),this.stopDrawing()},{passive:!1}),window.addEventListener("resize",()=>{clearTimeout(n),n=setTimeout(()=>{this.setupCanvas(),this.render()},100)})}setupCharacterSet(){const t=document.getElementById("char-grid");if(!t)return void console.error("char-grid element not found!");t.innerHTML="",console.log("Setting up character grid with",this.charArray.length,"characters");let e=0;this.charArray.forEach(s=>{const i=document.createElement("button");i.className="char-button",i.textContent=" "===s?"‚ê£":s,i.dataset.char=s,i.onclick=()=>this.selectCharacter(s),t.appendChild(i),e++}),console.log("Added",e,"buttons to grid. Grid children count:",t.children.length),console.log("Grid display style:",window.getComputedStyle(t).display),console.log("Grid visibility:",window.getComputedStyle(t).visibility),console.log("Grid parent display:",window.getComputedStyle(t.parentElement).display)}setupFontCreatorControls(){document.getElementById("clear-char").onclick=()=>this.clearCharacter(),document.getElementById("delete-char").onclick=()=>this.deleteCurrentCharacter(),document.getElementById("prev-char").onclick=()=>this.navigateCharacter(-1),document.getElementById("next-char").onclick=()=>this.navigateCharacter(1),document.getElementById("add-custom-char").onclick=()=>{const t=document.getElementById("custom-char-input"),e=t.value;e&&(this.addCustomCharacters(e),t.value="")},document.getElementById("custom-char-input").onkeypress=t=>{"Enter"===t.key&&document.getElementById("add-custom-char").click()},document.getElementById("undo").onclick=()=>this.undo(),document.getElementById("redo").onclick=()=>this.redo(),document.getElementById("new-font").onclick=()=>this.newFont(),document.getElementById("save-font").onclick=()=>this.saveFont(),document.getElementById("preview-font").onclick=()=>this.previewFont(),document.getElementById("delete-font").onclick=()=>this.deleteFont(),document.getElementById("import-svg-font-btn").onclick=()=>document.getElementById("import-svg-font").click(),document.getElementById("char-set-header").onclick=()=>{const t=document.getElementById("char-set-header"),e=t.nextElementSibling;t.classList.toggle("collapsed"),e.classList.toggle("collapsed")},document.getElementById("font-settings-header").onclick=()=>{const t=document.getElementById("font-settings-header"),e=document.getElementById("font-settings-content");t.classList.toggle("collapsed"),e.classList.toggle("collapsed")},document.getElementById("kerning-header").onclick=()=>{const t=document.getElementById("kerning-header"),e=document.getElementById("kerning-content");t.classList.toggle("collapsed"),e.classList.toggle("collapsed")},document.getElementById("font-selector-editor").onchange=t=>{const e=t.target.value;if(!e)return;const s=JSON.parse(localStorage.getItem("gcodeFonts")||"{}")[e];if(s){const t=this.currentChar;this.strokes=[],this.history=[],this.historyIndex=-1,this.loadFontData(s),localStorage.setItem("currentFontId",e),t&&this.font[t]?(this.currentChar=t,this.strokes=this.font[t].strokes?JSON.parse(JSON.stringify(this.font[t].strokes)):[],this.history=[JSON.parse(JSON.stringify(this.strokes))],this.historyIndex=0,document.getElementById("current-char").textContent=" "===t?"(space)":t,document.querySelectorAll(".char-button").forEach(e=>{e.classList.toggle("active",e.dataset.char===t)}),this.render(),this.updateStatus(`Loaded font: ${s.name} - Drawing: ${" "===t?"SPACE":t}`)):t?(this.currentChar=t,this.render(),document.getElementById("current-char").textContent=t,document.querySelectorAll(".char-button").forEach(e=>{e.classList.toggle("active",e.dataset.char===t)}),this.updateStatus(`Loaded font: ${s.name} - Character '${t}' not defined in this font`)):(this.render(),this.updateStatus(`Loaded font: ${s.name}`))}},document.getElementById("import-svg-font").onchange=t=>this.importSVGFont(t),document.getElementById("toggle-guides").onclick=()=>this.toggleGuides(),document.getElementById("add-kerning").onclick=()=>this.addKerning(),document.getElementById("ascent-pos").oninput=t=>this.updateGuidePosition("ascent",parseFloat(t.target.value)),document.getElementById("cap-height-pos").oninput=t=>this.updateGuidePosition("capHeight",parseFloat(t.target.value)),document.getElementById("x-height-pos").oninput=t=>this.updateGuidePosition("xHeight",parseFloat(t.target.value)),document.getElementById("baseline-pos").oninput=t=>this.updateGuidePosition("baseline",parseFloat(t.target.value)),document.getElementById("descent-pos").oninput=t=>this.updateGuidePosition("descent",parseFloat(t.target.value)),document.getElementById("reset-guides").onclick=()=>this.resetGuidePositions(),document.getElementById("close-preview").onclick=()=>{document.getElementById("font-preview-modal").style.display="none"},document.getElementById("font-preview-modal").onclick=t=>{"font-preview-modal"===t.target.id&&(document.getElementById("font-preview-modal").style.display="none")},document.addEventListener("keydown",t=>!t.ctrlKey&&!t.metaKey||"z"!==t.key||t.shiftKey?(t.ctrlKey||t.metaKey)&&("y"===t.key||"z"===t.key&&t.shiftKey)?(t.preventDefault(),void this.redo()):void 0:(t.preventDefault(),void this.undo()))}setupTextToGCodeControls(){document.getElementById("preview-gcode-btn").onclick=()=>{this.generateGCode(),document.querySelector('.tab-button[data-tab="gcode-preview"]').click()},document.getElementById("export-image").onclick=()=>this.exportImage(),document.getElementById("export-svg").onclick=()=>this.exportSVG(),document.getElementById("export-dxf").onclick=()=>this.exportDXF(),document.getElementById("export-svg-font").onclick=()=>this.exportSVGFont(),document.getElementById("font-selector").onchange=()=>this.loadSelectedFont()}getCanvasCoords(t){const e=this.canvas.getBoundingClientRect();let s=t.clientX-e.left;const i=t.clientY-e.top;if(this.currentChar){const t=this.normalizeCharacter(this.currentChar),e=this.font[t];if(void 0!==e?.horizAdvX){const t=this.fontMetrics.ascent-this.fontMetrics.descent,i=.7*this.canvas.height/t,n=e.horizAdvX*i;s-=(this.canvas.width-n)/2}}return{x:s,y:i,xOffset:this.getXOffset()}}getXOffset(){if(!this.currentChar)return 0;const t=this.normalizeCharacter(this.currentChar),e=this.font[t];if(void 0!==e?.horizAdvX){const t=this.fontMetrics.ascent-this.fontMetrics.descent,s=.7*this.canvas.height/t,i=e.horizAdvX*s;return(this.canvas.width-i)/2}return 0}checkLineHit(t,e,s=15){if(!this.currentChar)return null;if(e>40)return null;const i=this.getXOffset(),n=this.normalizeCharacter(this.currentChar),o=this.font[n];if(Math.abs(t-i)<s)return"origin";if(void 0!==o?.horizAdvX){const e=this.fontMetrics.ascent-this.fontMetrics.descent,n=.7*this.canvas.height/e,a=o.horizAdvX*n+i;if(Math.abs(t-a)<s)return"advance"}return null}startDrawing(t){if(!this.currentChar)return void this.updateStatus("Please select a character first");const e=this.canvas.getBoundingClientRect(),s=t.clientX-e.left,i=t.clientY-e.top,n=this.checkLineHit(s,i);if(n){if(this.isDraggingLine=!0,this.dragLineType=n,this.dragStartX=s,"origin"===n)this.dragLineStartValue=0;else if("advance"===n){const t=this.normalizeCharacter(this.currentChar),e=this.font[t];this.dragLineStartValue=e?.horizAdvX||0}return void(this.canvas.style.cursor="ew-resize")}this.isDrawing=!0;const o=this.getCanvasCoords(t);this.currentStroke=[{x:o.x,y:o.y}]}draw(t){if(this.isDraggingLine){const e=this.canvas.getBoundingClientRect(),s=t.clientX-e.left,i=s-this.dragStartX,n=this.normalizeCharacter(this.currentChar),o=this.font[n],a=this.fontMetrics.ascent-this.fontMetrics.descent,r=.7*this.canvas.height/a;if("origin"===this.dragLineType){const t=i/r;this.strokes.forEach(t=>{t.forEach(t=>{t.x-=i})}),o&&(o.horizAdvX=(o.horizAdvX||0)-t,this.updateCharacterInFont()),this.dragStartX=s,this.render()}else if("advance"===this.dragLineType){const t=i/r,e=this.dragLineStartValue+t;o&&e>0&&(o.horizAdvX=e,this.updateCharacterInFont(),this.render())}return}const e=this.canvas.getBoundingClientRect(),s=t.clientX-e.left,i=t.clientY-e.top,n=this.checkLineHit(s,i);if(this.canvas.style.cursor=n?"grab":"crosshair",!this.isDrawing||!this.currentStroke)return;const o=this.getCanvasCoords(t);this.currentStroke.push({x:o.x,y:o.y}),this.render();let a=0;if(this.currentChar){const t=this.normalizeCharacter(this.currentChar),e=this.font[t];if(void 0!==e?.horizAdvX){const t=this.fontMetrics.ascent-this.fontMetrics.descent,s=.7*this.canvas.height/t,i=e.horizAdvX*s;a=(this.canvas.width-i)/2}}this.ctx.strokeStyle="#4CAF50",this.ctx.lineWidth=2,this.ctx.lineCap="round",this.ctx.lineJoin="round",this.ctx.beginPath(),this.ctx.moveTo(this.currentStroke[0].x+a,this.currentStroke[0].y);for(let t=1;t<this.currentStroke.length;t++)this.ctx.lineTo(this.currentStroke[t].x+a,this.currentStroke[t].y);this.ctx.stroke()}stopDrawing(){if(this.isDraggingLine)return this.isDraggingLine=!1,this.dragLineType=null,this.canvas.style.cursor="crosshair",this.saveToHistory(),void this.saveToLocalStorage();if(this.isDrawing&&this.currentStroke){if(this.isDrawing=!1,this.currentStroke.length>1){const t=parseFloat(document.getElementById("simplify-tolerance").value);this.strokes.push(this.simplifyPath(this.currentStroke,t)),this.saveToHistory(),this.updateCharacterInFont()}this.currentStroke=null,this.render()}}simplifyPath(t,e){return t.length<3?t:this.douglasPeucker(t,e)}douglasPeucker(t,e){if(t.length<3)return t;let s=0,i=0;const n=t[0],o=t[t.length-1];for(let e=1;e<t.length-1;e++){const a=this.calculateDistanceToLine(t[e],n,o);a>s&&(s=a,i=e)}if(s>e){const s=this.douglasPeucker(t.slice(0,i+1),e),n=this.douglasPeucker(t.slice(i),e);return s.slice(0,-1).concat(n)}return[n,o]}calculateDistanceToLine(t,e,s){const i=s.x-e.x,n=s.y-e.y,o=Math.sqrt(i*i+n*n);if(0===o)return Math.sqrt((t.x-e.x)**2+(t.y-e.y)**2);const a=((t.x-e.x)*i+(t.y-e.y)*n)/(o*o),r=e.x+a*i,h=e.y+a*n;return Math.sqrt((t.x-r)**2+(t.y-h)**2)}detectArcs(t){if(t.length<5)return[{type:"line",points:t}];const e=[];let s=0;for(;s<t.length;){const i=this.fitArc(t,s);if(i&&i.endIndex-s>=3)e.push({type:"arc",start:t[s],end:t[i.endIndex],center:i.center,radius:i.radius,clockwise:i.clockwise}),s=i.endIndex;else{const i=Math.min(s+1,t.length-1);e.push({type:"line",points:t.slice(s,i+1)}),s=s===i?s+1:i}}return e}fitArc(t,e){const s=parseFloat(document.getElementById("arc-tolerance").value);for(let i=Math.min(e+20,t.length)-1;i>e+2;i--){const n=t.slice(e,i+1);if(this.isCollinear(n,s))continue;const o=this.fitCircle(n);if(!o)continue;if(o.r<.5||o.r>50)continue;let a=!0,r=0;for(const t of n){const e=Math.sqrt((t.x-o.cx)**2+(t.y-o.cy)**2),i=Math.abs(e-o.r);if(r=Math.max(r,i),i>s){a=!1;break}}if(a){const t=n[0],e=n[n.length-1],s=Math.atan2(t.y-o.cy,t.x-o.cx);let a=Math.atan2(e.y-o.cy,e.x-o.cx)-s;for(;a>Math.PI;)a-=2*Math.PI;for(;a<-Math.PI;)a+=2*Math.PI;const h=180*Math.abs(a)/Math.PI;if(h<20)continue;const c=e.x-t.x,l=e.y-t.y,d=Math.sqrt(c*c+l*l),u=o.r*Math.abs(a),g=d>0?u/d:0;if(g<1.05)continue;const m=this.isClockwise(n,o);return console.log(`Arc fitted: radius=${o.r.toFixed(2)}, angle=${h.toFixed(1)}¬∞, chord/arc=${g.toFixed(3)}, maxError=${r.toFixed(3)}, CW=${m}`),{endIndex:i,center:{x:o.cx,y:o.cy},radius:o.r,clockwise:m}}}return null}fitCircle(t){if(t.length<3)return null;let e=0,s=0,i=0,n=0,o=0,a=0,r=0,h=0,c=0;for(const l of t){const t=l.x,d=l.y,u=t*t,g=d*d;e+=t,s+=d,i+=u,n+=g,o+=t*d,a+=u*t,r+=g*d,h+=u*d,c+=t*g}const l=t.length,d=l*i-e*e,u=l*o-e*s,g=l*n-s*s,m=.5*(l*c-e*n+l*a-e*i),f=.5*(l*r-s*n+l*h-s*i),p=d*g-u*u;if(Math.abs(p)<1e-10)return null;const x=(m*g-u*f)/p,y=(d*f-u*m)/p;let v=0;for(const e of t)v+=Math.sqrt((e.x-x)**2+(e.y-y)**2);return{cx:x,cy:y,r:v/l}}isCollinear(t,e){if(t.length<3)return!0;const s=t[0],i=t[t.length-1],n=i.x-s.x,o=i.y-s.y,a=Math.sqrt(n*n+o*o);if(a<.1)return!0;for(let r=1;r<t.length-1;r++){const h=t[r];if(Math.abs((o*h.x-n*h.y+i.x*s.y-i.y*s.x)/a)>e)return!1}for(let e=0;e<t.length-2;e++){const s=t[e],i=t[e+1],n=t[e+2],o=i.x-s.x,a=i.y-s.y,r=n.x-i.x,h=n.y-i.y,c=Math.sqrt(o*o+a*a),l=Math.sqrt(r*r+h*h);if(c<.1||l<.1)continue;const d=o/c*(r/l)+a/c*(h/l);if(Math.abs(d)<.95)return!1}return!0}isClockwise(t,e){if(t.length<2)return!1;const s=t[0],i=t[t.length-1],n=t[Math.floor(t.length/2)],o=Math.atan2(s.y-e.cy,s.x-e.cx);let a=Math.atan2(n.y-e.cy,n.x-e.cx)-o,r=Math.atan2(i.y-e.cy,i.x-e.cx)-o;for(;a>Math.PI;)a-=2*Math.PI;for(;a<-Math.PI;)a+=2*Math.PI;for(;r>Math.PI;)r-=2*Math.PI;for(;r<-Math.PI;)r+=2*Math.PI;return a<0}navigateCharacter(t){if(!this.currentChar)return void this.selectCharacter(this.charArray[0]);const e=this.charArray.indexOf(this.currentChar);if(-1===e)return;let s=e+t;s<0&&(s=this.charArray.length-1),s>=this.charArray.length&&(s=0),this.selectCharacter(this.charArray[s])}selectCharacter(t){this.currentChar&&this.strokes.length>0&&this.updateCharacterInFont(),this.currentChar=t;const e=this.normalizeCharacter(t);if(this.strokes=this.font[e]?.strokes?JSON.parse(JSON.stringify(this.font[e].strokes)):[],!this.font[e]){const t=this.canvas.width,s=this.fontMetrics.ascent-this.fontMetrics.descent,i=.7*this.canvas.height/s,n=.5*t;this.font[e]={strokes:[],bounds:{minX:0,minY:0,maxX:0,maxY:0,width:0,height:0},horizAdvX:n/i}}this.history=[JSON.parse(JSON.stringify(this.strokes))],this.historyIndex=0,document.getElementById("current-char").textContent=" "===t?"(space)":t,document.querySelectorAll(".char-button").forEach(e=>{e.classList.toggle("active",e.dataset.char===t)});const s=document.getElementById("delete-char");this.defaultCharArray.includes(t)?s.style.display="none":s.style.display="block",this.render(),this.updateStatus(`Drawing: ${" "===t?"SPACE":t}`)}updateCharacterInFont(){if(!this.currentChar)return;const t=this.calculateBounds(this.strokes),e=this.font[this.currentChar],s=e?.horizAdvX;this.font[this.currentChar]={strokes:JSON.parse(JSON.stringify(this.strokes)),bounds:t},void 0!==s&&(this.font[this.currentChar].horizAdvX=s);const i=Array.from(document.querySelectorAll(".char-button")).find(t=>t.dataset.char===this.currentChar);i&&i.classList.add("defined"),this.saveToLocalStorage()}calculateBounds(t){if(!t||0===t.length)return{minX:0,minY:0,maxX:0,maxY:0,width:0,height:0};let e=1/0,s=1/0,i=-1/0,n=-1/0;return t.forEach(t=>{t&&0!==t.length&&t.forEach(t=>{e=Math.min(e,t.x),s=Math.min(s,t.y),i=Math.max(i,t.x),n=Math.max(n,t.y)})}),e===1/0||s===1/0?{minX:0,minY:0,maxX:0,maxY:0,width:0,height:0}:{minX:e,minY:s,maxX:i,maxY:n,width:i-e,height:n-s}}render(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);let t=0;if(this.currentChar){const e=this.normalizeCharacter(this.currentChar),s=this.font[e];if(void 0!==s?.horizAdvX){const e=this.fontMetrics.ascent-this.fontMetrics.descent,i=.7*this.canvas.height/e,n=s.horizAdvX*i;t=(this.canvas.width-n)/2}}this.ctx.strokeStyle="#e0e0e0",this.ctx.lineWidth=1;for(let t=0;t<=20;t++){const e=t*this.gridSize;this.ctx.beginPath(),this.ctx.moveTo(e,0),this.ctx.lineTo(e,this.canvas.height),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(0,e),this.ctx.lineTo(this.canvas.width,e),this.ctx.stroke()}if(this.showGuides){const t=this.fontMetrics.ascent-this.fontMetrics.descent,e=.7*this.canvas.height/t,s=.75*this.canvas.height,i=s-this.guidePositions.ascent*e,n=s-this.guidePositions.capHeight*e,o=s-this.guidePositions.xHeight*e,a=s-this.guidePositions.baseline*e,r=s-this.guidePositions.descent*e;this.ctx.setLineDash([5,5]),this.ctx.lineWidth=2,this.ctx.font="12px sans-serif",this.ctx.strokeStyle="rgba(128, 0, 128, 0.5)",this.ctx.fillStyle="rgba(128, 0, 128, 0.7)",this.ctx.beginPath(),this.ctx.moveTo(0,i),this.ctx.lineTo(this.canvas.width,i),this.ctx.stroke(),this.ctx.fillText("Ascent",5,i-5),this.ctx.strokeStyle="rgba(0, 0, 255, 0.5)",this.ctx.fillStyle="rgba(0, 0, 255, 0.7)",this.ctx.beginPath(),this.ctx.moveTo(0,n),this.ctx.lineTo(this.canvas.width,n),this.ctx.stroke(),this.ctx.fillText("Cap",5,n-5),this.ctx.strokeStyle="rgba(0, 255, 0, 0.5)",this.ctx.fillStyle="rgba(0, 255, 0, 0.7)",this.ctx.beginPath(),this.ctx.moveTo(0,o),this.ctx.lineTo(this.canvas.width,o),this.ctx.stroke(),this.ctx.fillText("X-Height",5,o-5),this.ctx.strokeStyle="rgba(255, 0, 0, 0.5)",this.ctx.fillStyle="rgba(255, 0, 0, 0.7)",this.ctx.beginPath(),this.ctx.moveTo(0,a),this.ctx.lineTo(this.canvas.width,a),this.ctx.stroke(),this.ctx.fillText("Baseline",5,a+15),this.ctx.strokeStyle="rgba(255, 165, 0, 0.5)",this.ctx.fillStyle="rgba(255, 165, 0, 0.7)",this.ctx.beginPath(),this.ctx.moveTo(0,r),this.ctx.lineTo(this.canvas.width,r),this.ctx.stroke(),this.ctx.fillText("Descent",5,r+15),this.ctx.setLineDash([])}if(this.ctx.strokeStyle="#333333",this.ctx.lineWidth=2,this.ctx.lineCap="round",this.ctx.lineJoin="round",this.strokes.forEach((e,s)=>{if(!(e.length<2)){this.ctx.beginPath(),this.ctx.moveTo(e[0].x+t,e[0].y);for(let s=1;s<e.length;s++)this.ctx.lineTo(e[s].x+t,e[s].y);this.ctx.stroke(),this.ctx.fillStyle="#4CAF50",this.ctx.beginPath(),this.ctx.arc(e[0].x+t,e[0].y,4,0,2*Math.PI),this.ctx.fill(),this.ctx.fillStyle="#4CAF50",this.ctx.font="12px sans-serif",this.ctx.fillText(s+1,e[0].x+t+8,e[0].y-8),this.ctx.fillStyle="#f44336",this.ctx.beginPath(),this.ctx.arc(e[e.length-1].x+t,e[e.length-1].y,3,0,2*Math.PI),this.ctx.fill()}}),this.currentChar){const e=this.normalizeCharacter(this.currentChar),s=this.font[e];if(this.ctx.strokeStyle="rgba(0, 0, 0, 0.7)",this.ctx.lineWidth=2,this.ctx.setLineDash([5,3]),this.ctx.beginPath(),this.ctx.moveTo(t,0),this.ctx.lineTo(t,this.canvas.height),this.ctx.stroke(),this.ctx.setLineDash([]),this.ctx.fillStyle="rgba(0, 0, 0, 0.8)",this.ctx.strokeStyle="rgba(0, 0, 0, 0.9)",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.roundRect(t-15,5,30,30,5),this.ctx.fill(),this.ctx.stroke(),this.ctx.strokeStyle="white",this.ctx.lineWidth=2,this.ctx.lineCap="round",this.ctx.beginPath(),this.ctx.moveTo(t-8,20),this.ctx.lineTo(t-2,20),this.ctx.moveTo(t-8,20),this.ctx.lineTo(t-5,17),this.ctx.moveTo(t-8,20),this.ctx.lineTo(t-5,23),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(t+8,20),this.ctx.lineTo(t+2,20),this.ctx.moveTo(t+8,20),this.ctx.lineTo(t+5,17),this.ctx.moveTo(t+8,20),this.ctx.lineTo(t+5,23),this.ctx.stroke(),this.ctx.fillStyle="rgba(0, 0, 0, 0.8)",this.ctx.font="bold 12px sans-serif",this.ctx.fillText("Origin (0)",t+5,50),void 0!==s?.horizAdvX){const e=this.fontMetrics.ascent-this.fontMetrics.descent,i=.7*this.canvas.height/e,n=s.horizAdvX*i;this.ctx.strokeStyle="rgba(255, 0, 255, 0.6)",this.ctx.lineWidth=2,this.ctx.setLineDash([5,5]),this.ctx.beginPath(),this.ctx.moveTo(n+t,0),this.ctx.lineTo(n+t,this.canvas.height),this.ctx.stroke(),this.ctx.setLineDash([]),this.ctx.fillStyle="rgba(255, 0, 255, 0.8)",this.ctx.strokeStyle="rgba(200, 0, 200, 0.9)",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.roundRect(n+t-15,5,30,30,5),this.ctx.fill(),this.ctx.stroke(),this.ctx.strokeStyle="white",this.ctx.lineWidth=2,this.ctx.lineCap="round";const o=n+t;this.ctx.beginPath(),this.ctx.moveTo(o-8,20),this.ctx.lineTo(o-2,20),this.ctx.moveTo(o-8,20),this.ctx.lineTo(o-5,17),this.ctx.moveTo(o-8,20),this.ctx.lineTo(o-5,23),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(o+8,20),this.ctx.lineTo(o+2,20),this.ctx.moveTo(o+8,20),this.ctx.lineTo(o+5,17),this.ctx.moveTo(o+8,20),this.ctx.lineTo(o+5,23),this.ctx.stroke(),this.ctx.fillStyle="rgba(255, 0, 255, 0.8)",this.ctx.font="12px sans-serif",this.ctx.fillText(`Advance (${Math.round(s.horizAdvX)})`,n+t+5,50)}this.ctx.setLineDash([])}}clearCharacter(){if(this.strokes=[],this.history=[],this.historyIndex=-1,this.currentChar){const t=this.normalizeCharacter(this.currentChar),e=this.canvas.width,s=this.fontMetrics.ascent-this.fontMetrics.descent,i=.7*this.canvas.height/s,n=.5*e;this.font[t]={strokes:[],bounds:{minX:0,minY:0,maxX:0,maxY:0,width:0,height:0},horizAdvX:n/i};const o=Array.from(document.querySelectorAll(".char-button")).find(t=>t.dataset.char===this.currentChar);o&&o.classList.remove("defined")}this.render(),this.saveToLocalStorage()}addCustomCharacters(t){let e=0;for(const s of t)this.charArray.includes(s)||(this.charArray.push(s),e++);e>0?(this.setupCharacterSet(),Object.keys(this.font).forEach(t=>{const e=Array.from(document.querySelectorAll(".char-button")).find(e=>e.dataset.char===t);e&&e.classList.add("defined")}),this.updateStatus(`Added ${e} character(s) to set`)):this.updateStatus("Character(s) already in set")}removeCustomCharacter(t){if(this.defaultCharArray.includes(t))return void this.updateStatus("Cannot remove default characters");const e=this.charArray.indexOf(t);if(e>-1){const s=this.normalizeCharacter(t);if(this.font[s]?.strokes?.length>0&&!confirm(`Character "${t}" has a glyph defined. Remove it from the character set?`))return;this.charArray.splice(e,1),this.currentChar===t&&(this.currentChar=null,this.charArray.length>0&&this.selectCharacter(this.charArray[0])),this.setupCharacterSet(),Object.keys(this.font).forEach(t=>{const e=Array.from(document.querySelectorAll(".char-button")).find(e=>e.dataset.char===t);e&&e.classList.add("defined")}),this.updateStatus(`Removed "${t}" from character set`)}}deleteCurrentCharacter(){this.currentChar&&this.removeCustomCharacter(this.currentChar)}clearCanvas(){this.strokes=[],this.saveToHistory(),this.render()}saveToHistory(){this.history=this.history.slice(0,this.historyIndex+1),this.history.push(JSON.parse(JSON.stringify(this.strokes))),this.historyIndex++,this.history.length>50&&(this.history.shift(),this.historyIndex--)}undo(){this.historyIndex>0&&(this.historyIndex--,this.strokes=JSON.parse(JSON.stringify(this.history[this.historyIndex])),this.updateCharacterInFont(),this.render())}redo(){this.historyIndex<this.history.length-1&&(this.historyIndex++,this.strokes=JSON.parse(JSON.stringify(this.history[this.historyIndex])),this.updateCharacterInFont(),this.render())}saveFont(){this.updateCharacterInFont(),this.saveToLocalStorage(),this.updateStatus("Font saved!"),setTimeout(()=>this.updateStatus("Ready"),2e3)}newFont(){Object.keys(this.font).length>0&&!confirm("Starting a new font will clear your current work. Continue?")||(this.font={},this.kerning=[],this.currentFontId="font_"+Date.now(),document.getElementById("font-name").value="New Font",this.strokes=[],this.currentChar=null,this.history=[],this.historyIndex=-1,document.querySelectorAll(".char-button").forEach(t=>t.classList.remove("defined","active")),document.getElementById("current-char").textContent="-",this.updateKerningList(),this.render(),this.saveToLocalStorage(),this.updateFontSelector(),this.updateStatus("New font created"))}deleteFont(){if(!this.currentFontId)return void alert("No font to delete");const t=document.getElementById("font-name").value;if(!confirm(`Delete font "${t}"? This cannot be undone.`))return;const e=JSON.parse(localStorage.getItem("gcodeFonts")||"{}");if(delete e[this.currentFontId],localStorage.setItem("gcodeFonts",JSON.stringify(e)),Object.keys(e).length>0){const t=Object.values(e)[0];this.loadFontData(t),localStorage.setItem("currentFontId",t.id)}else this.newFont();this.updateFontSelector(),this.updateStatus(`Font "${t}" deleted`)}loadFontFromList(){const t=JSON.parse(localStorage.getItem("gcodeFonts")||"{}"),e=Object.values(t).sort((t,e)=>t.name.localeCompare(e.name));if(0===e.length)return void alert("No saved fonts found. Create a new font or import one.");let s="Select a font to load:\n\n";e.forEach((t,e)=>{s+=`${e+1}. ${t.name}\n`}),s+="\nEnter the number of the font to load:";const i=prompt(s);if(!i)return;const n=parseInt(i)-1;if(n>=0&&n<e.length){const t=e[n];this.loadFontData(t),localStorage.setItem("currentFontId",t.id),this.updateStatus(`Loaded font: ${t.name}`)}else alert("Invalid selection")}saveToLocalStorage(){const t=JSON.parse(localStorage.getItem("gcodeFonts")||"{}");this.currentFontId||(this.currentFontId="font_"+Date.now()),t[this.currentFontId]={id:this.currentFontId,name:document.getElementById("font-name").value,glyphs:this.font,kerning:this.kerning,fontMetrics:this.fontMetrics,lastModified:(new Date).toISOString()},localStorage.setItem("gcodeFonts",JSON.stringify(t)),localStorage.setItem("currentFontId",this.currentFontId),this.updateFontSelector()}loadFromLocalStorage(){const t=localStorage.getItem("currentFontId"),e=JSON.parse(localStorage.getItem("gcodeFonts")||"{}");if(t&&e[t])this.loadFontData(e[t]);else if(Object.keys(e).length>0){const t=Object.values(e)[0];this.loadFontData(t)}else this.newFont();this.updateFontSelector()}loadFontData(t){this.currentFontId=t.id,this.font=t.glyphs||{},Array.isArray(t.kerning)?this.kerning=t.kerning:(t.kerning&&t.kerning,this.kerning=[]),this.fontMetrics=t.fontMetrics||{unitsPerEm:1e3,ascent:800,descent:-200,capHeight:700,xHeight:500},document.getElementById("font-name").value=t.name||"Custom Font";const e=Object.keys(this.font).filter(t=>!this.charArray.includes(t));e.length>0&&(this.charArray.push(...e),this.setupCharacterSet()),document.querySelectorAll(".char-button").forEach(t=>t.classList.remove("defined")),Object.keys(this.font).forEach(t=>{const e=Array.from(document.querySelectorAll(".char-button")).find(e=>e.dataset.char===t);e&&e.classList.add("defined")}),this.updateKerningList()}updateFontSelector(){const t=document.getElementById("font-selector-editor"),e=document.getElementById("font-selector"),s=JSON.parse(localStorage.getItem("gcodeFonts")||"{}"),i=localStorage.getItem("currentFontId");t&&(t.innerHTML='<option value="">Select a font...</option>',Object.values(s).sort((t,e)=>t.name.localeCompare(e.name)).forEach(e=>{const s=document.createElement("option");s.value=e.id,s.textContent=e.name,e.id===i&&(s.selected=!0),t.appendChild(s)})),e&&(e.innerHTML='<option value="">Select a font...</option>',Object.values(s).sort((t,e)=>t.name.localeCompare(e.name)).forEach(t=>{const s=document.createElement("option");s.value=t.id,s.textContent=t.name,t.id===i&&(s.selected=!0),e.appendChild(s)}))}loadSelectedFont(){const t=document.getElementById("font-selector").value;if(!t)return void this.updateStatus("Please select a font");const e=JSON.parse(localStorage.getItem("gcodeFonts")||"{}");e[t]&&(this.loadFontData(e[t]),this.updateStatus(`Loaded font: ${e[t].name}`))}previewFont(){const t=document.getElementById("font-preview-modal"),e=document.getElementById("preview-canvas"),s=e.getContext("2d"),i=Object.keys(this.font).sort();if(0===i.length)return void alert("No characters defined in font");const n=Math.floor((e.width-40)/100),o=Math.ceil(i.length/n);e.height=Math.min(2400,Math.max(800,20+120*o+20)),s.fillStyle=getComputedStyle(document.documentElement).getPropertyValue("--bg-color"),s.fillRect(0,0,e.width,e.height),s.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue("--text-color"),s.fillStyle=getComputedStyle(document.documentElement).getPropertyValue("--text-color"),s.lineWidth=2,s.lineCap="round",s.lineJoin="round",s.font="12px monospace",s.textAlign="center",i.forEach((t,e)=>{const i=e%n,o=Math.floor(e/n),a=20+100*i,r=20+120*o;s.fillText(t,a+40,r+80+15);const h=this.normalizeCharacter(t),c=this.font[h];if(!c||!c.strokes)return;const l=80/this.canvas.height,d=80/this.canvas.height;c.strokes.forEach(t=>{t.length<2||(s.beginPath(),t.forEach((t,e)=>{const i=a+t.x*l,n=r+t.y*d;0===e?s.moveTo(i,n):s.lineTo(i,n)}),s.stroke())})}),t.style.display="flex"}importSVGFont(t){const e=t.target.files[0];if(!e)return;const s=new FileReader;s.onload=t=>{try{const e=(new DOMParser).parseFromString(t.target.result,"image/svg+xml");if(e.querySelector("parsererror"))throw new Error("Invalid SVG file");const s=e.querySelector("font");if(!s)throw new Error("No font found in SVG file");const i=s.querySelector("font-face"),n=parseFloat(i?.getAttribute("units-per-em")||"1000"),o=i?.getAttribute("font-family")||"Imported SVG Font",a=parseFloat(i?.getAttribute("ascent")||.8*n),r=parseFloat(i?.getAttribute("descent")||-.2*n),h=parseFloat(i?.getAttribute("cap-height")||.7*n),c=parseFloat(i?.getAttribute("x-height")||.5*n),l=this.canvas.height,d=.7*l/(a-r),u=.75*l;this.guidePositions.ascent=a,this.guidePositions.capHeight=h,this.guidePositions.xHeight=c,this.guidePositions.baseline=0,this.guidePositions.descent=r,this.updateGuidePositionInputs(),this.fontMetrics={unitsPerEm:n,ascent:a,descent:r,capHeight:h,xHeight:c};const g=s.querySelectorAll("glyph"),m={};let f=0;if(g.forEach(t=>{const e=t.getAttribute("unicode");if(!e||0===e.length)return;const i=t.getAttribute("d"),n=parseFloat(t.getAttribute("horiz-adv-x")||s.getAttribute("horiz-adv-x")||"1000"),o=i?this.parseSVGPath(i,d,u,a):[],r=o.length>0?this.calculateBounds(o):{minX:0,maxX:0,minY:0,maxY:0,width:0,height:0};m[e]={strokes:o,bounds:r,horizAdvX:n},f++}),0===f)throw new Error("No valid glyphs found in SVG font");const p=s.querySelectorAll("hkern"),x=[];p.forEach(t=>{const e=t.getAttribute("u1"),s=t.getAttribute("u2"),i=t.getAttribute("g1"),n=t.getAttribute("g2"),o=parseFloat(t.getAttribute("k")||"0")/d;e&&s?x.push({type:"unicode",u1:e,u2:s,k:o}):i&&n&&x.push({type:"glyph",g1:i,g2:n,k:o})}),this.currentFontId="font_"+Date.now(),this.font=m,this.kerning=x,document.getElementById("font-name").value=o,document.querySelectorAll(".char-button").forEach(t=>t.classList.remove("defined")),Object.keys(this.font).forEach(t=>{const e=Array.from(document.querySelectorAll(".char-button")).find(e=>e.dataset.char===t);e&&e.classList.add("defined")}),this.render(),this.saveToLocalStorage(),this.updateStatus(`SVG Font imported: ${o} (${f} characters)`)}catch(t){alert("Error importing SVG font: "+t.message)}},s.readAsText(e)}parseSVGPath(t,e,s,i){const n=[];let o=[],a=0,r=0,h=0,c=0;const l=t=>s-t*e,d=t.match(/[MmLlHhVvQqTtCcSsAaZz][^MmLlHhVvQqTtCcSsAaZz]*/g);return d?(d.forEach(t=>{const s=t[0],i=t.slice(1).trim().split(/[\s,]+/).filter(t=>t).map(parseFloat);switch(s){case"M":o.length>0&&(n.push(o),o=[]),a=i[0],r=i[1],h=a,c=r,o.push({x:a*e,y:l(r)});break;case"m":o.length>0&&(n.push(o),o=[]),a+=i[0],r+=i[1],h=a,c=r,o.push({x:a*e,y:l(r)});break;case"L":for(let t=0;t<i.length;t+=2)a=i[t],r=i[t+1],o.push({x:a*e,y:l(r)});break;case"l":for(let t=0;t<i.length;t+=2)a+=i[t],r+=i[t+1],o.push({x:a*e,y:l(r)});break;case"H":i.forEach(t=>{a=t,o.push({x:a*e,y:l(r)})});break;case"h":i.forEach(t=>{a+=t,o.push({x:a*e,y:l(r)})});break;case"V":i.forEach(t=>{r=t,o.push({x:a*e,y:l(r)})});break;case"v":i.forEach(t=>{r+=t,o.push({x:a*e,y:l(r)})});break;case"Q":for(let t=0;t<i.length;t+=4){const s=i[t],n=i[t+1],h=i[t+2],c=i[t+3],d=10;for(let t=1;t<=d;t++){const i=t/d,u=1-i,g=u*u*a+2*u*i*s+i*i*h,m=u*u*r+2*u*i*n+i*i*c;o.push({x:g*e,y:l(m)})}a=h,r=c}break;case"q":for(let t=0;t<i.length;t+=4){const s=a+i[t],n=r+i[t+1],h=a+i[t+2],c=r+i[t+3],d=10;for(let t=1;t<=d;t++){const i=t/d,u=1-i,g=u*u*a+2*u*i*s+i*i*h,m=u*u*r+2*u*i*n+i*i*c;o.push({x:g*e,y:l(m)})}a=h,r=c}break;case"Z":case"z":if(o.length>0){const t=o[o.length-1],e=o[0];(Math.abs(t.x-e.x)>.1||Math.abs(t.y-e.y)>.1)&&o.push({x:e.x,y:e.y})}a=h,r=c}}),o.length>0&&n.push(o),n):n}normalizeCharacter(t){return{"‚Äô":"'","‚Äò":"'","‚Äú":'"',"‚Äù":'"',"‚Äì":"-","‚Äî":"-","‚Ä¶":"..."}[t]||t}getKerningAdjustment(t,e){let s=0;for(const i of this.kerning)if("unicode"===i.type)this.matchesUnicodePattern(t,i.u1)&&this.matchesUnicodePattern(e,i.u2)&&(s+=i.k);else if("glyph"===i.type){const n=this.getGlyphName(t),o=this.getGlyphName(e);this.matchesGlyphPattern(n,i.g1)&&this.matchesGlyphPattern(o,i.g2)&&(s+=i.k)}return s}matchesUnicodePattern(t,e){if(!e)return!1;if(e===t)return!0;if(e.includes(",")&&e.split(",").map(t=>t.trim()).includes(t))return!0;if(e.includes("-")&&e.length>=3){const s=e.split("-");if(2===s.length){const e=s[0].charCodeAt(0),i=s[1].charCodeAt(0),n=t.charCodeAt(0);if(n>=e&&n<=i)return!0}}return!1}getGlyphName(t){const e=this.normalizeCharacter(t),s=this.font[e];return s?.glyphName||t}matchesGlyphPattern(t,e){return!!(e&&t&&(e===t||e.includes(",")&&e.split(",").map(t=>t.trim()).includes(t)))}generateGCode(){const t=document.getElementById("text-input").value;let e=parseFloat(document.getElementById("output-size").value);const s=parseFloat(document.getElementById("char-spacing").value),i=parseFloat(document.getElementById("space-width").value),n=parseFloat(document.getElementById("line-spacing").value),o=parseFloat(document.getElementById("max-width").value),a=parseFloat(document.getElementById("max-height").value),r=document.getElementById("auto-fit").checked,h=parseFloat(document.getElementById("feed-rate").value),c=parseFloat(document.getElementById("plunge-rate").value),l=parseFloat(document.getElementById("safe-z").value),d=parseFloat(document.getElementById("engrave-depth").value),u=this.canvas.height;let g=e/u,m=e+n,f=[],p="",x=null;const y=t=>{t!==p&&(f.push(t),p=t)};f.push("; GCode Font Creator Output"),f.push(`; Font: ${document.getElementById("font-name").value}`);const v=t.split("\n");1===v.length?f.push(`; Text: ${t}`):(f.push("; Text:"),v.forEach(t=>f.push(`; ${t}`))),f.push(`; Generated: ${(new Date).toISOString()}`),f.push(""),f.push("G21 ; mm mode"),f.push("G90 ; Absolute positioning"),f.push("G17 ; XY plane"),f.push(`G0 Z${l} F${c} ; Move to safe Z`),p=`G0 Z${l} F${c} ; Move to safe Z`,f.push("");const b=t.split("\n");let E=[];if(o>0?b.forEach(t=>{const n=t.split(" ");let a="",r=0;n.forEach((t,n)=>{let h=0;for(let i=0;i<t.length;i++){const n=t[i],o=this.normalizeCharacter(n),a=this.font[o];if(a){let t;if(void 0!==a.horizAdvX){const e=this.fontMetrics.ascent-this.fontMetrics.descent,s=.7*this.canvas.height/e;t=a.horizAdvX*s}else t=a.bounds.width;h+=t*g+s}else h+=.5*e+s}const c=this.font[" "];let l;if(void 0!==c?.horizAdvX){const t=this.fontMetrics.ascent-this.fontMetrics.descent,e=.7*this.canvas.height/t;l=c.horizAdvX*e*g}else l=i;const d=l+s;a.length>0&&r+d+h>o?(E.push(a),a=t,r=h):a.length>0?(a+=" "+t,r+=d+h):(a=t,r=h)}),E.push(a)}):E.push(...b),r&&(o>0||a>0)){const t=parseFloat(document.getElementById("max-text-size").value),r=t=>{const e=t/u,a=t+n,r=[];o>0?b.forEach(n=>{const a=n.split(" ");let h="",c=0;a.forEach(n=>{let a=0;for(let i=0;i<n.length;i++){const o=n[i],r=this.font[o];a+=r?r.bounds.width*e+s:.5*t+s}const l=i+s;h.length>0&&c+l+a>o?(r.push(h),h=n,c=a):h.length>0?(h+=" "+n,c+=l+a):(h=n,c=a)}),r.push(h)}):r.push(...b);let h=0;r.forEach(n=>{let o=0;for(let a=0;a<n.length;a++){const r=n[a],h=this.normalizeCharacter(r),c=this.font[h];if(c)o+=void 0!==c.horizAdvX?c.horizAdvX*e+s:c.bounds.width*e+s;else if(" "===r){const t=this.font[" "];o+=void 0!==t?.horizAdvX?t.horizAdvX*e+s:i+s}else o+=.5*t+s}h=Math.max(h,o)});let c=t;for(let e=1;e<r.length;e++)c+=0===r[e].length?.5*t:a;return{width:h,height:c,wrappedLines:r}};let h=e,c=E;for(let s=e;s<=t;s+=.5){const t=r(s),e=o<=0||t.width<=o,i=a<=0||t.height<=a;if(!e||!i)break;h=s,c=t.wrappedLines}e=h,E=c,g=e/u,m=e+n}let C=e;for(let t=1;t<E.length;t++)C+=0===E[t].length?.5*e:m;let M=C;E.forEach((t,n)=>{let o=0;f.push(""),f.push(`; Line ${n+1}: "${t}"`);for(let n=0;n<t.length;n++){const a=t[n],r=this.normalizeCharacter(a),u=this.font[r];if(!u){if(console.warn(`Character '${a}' (code: ${a.charCodeAt(0)}) not found in font`)," "===a){const t=this.font[" "];let e;if(void 0!==t?.horizAdvX){const i=this.fontMetrics.ascent-this.fontMetrics.descent,n=.7*this.canvas.height/i;e=t.horizAdvX*n*g+s}else e=i+s;o+=e}else o+=.5*e+s;continue}f.push(`; Character: '${a}'`);const m=u.bounds;let p=!0;u.strokes.forEach(t=>{const e=this.detectArcs(t);console.log(`Character '${a}' segments:`,e.map(t=>t.type));let s=!0;e.forEach(t=>{if("arc"===t.type){const e=(t.start.x-m.minX)*g+o,i=M-t.start.y*g,n=(t.end.x-m.minX)*g+o,a=M-t.end.y*g,r=(t.center.x-m.minX)*g+o,u=M-t.center.y*g;if(s){p||(y(`G0 Z${l}`),x=null);const t=x!==h?` F${h}`:"";y(`G0 X${e.toFixed(3)} Y${i.toFixed(3)}${t}`),x=h,y(`G1 Z${d}${x!==c?` F${c}`:""}`),x=c,s=!1,p=!1}const f=r-e,v=u-i,b=Math.sqrt(f*f+v*v),E=Math.sqrt((n-r)**2+(a-u)**2);Math.abs(b-E)>.01&&console.warn(`Arc validation failed: start radius ${b.toFixed(3)} != end radius ${E.toFixed(3)}`);const C=t.clockwise?"G3":"G2",I=x!==h?` F${h}`:"";y(`${C} X${n.toFixed(3)} Y${a.toFixed(3)} I${f.toFixed(3)} J${v.toFixed(3)}${I}`),x=h}else t.points.forEach((t,e)=>{const i=(t.x-m.minX)*g+o,n=M-t.y*g;if(s&&0===e){p||(y(`G0 Z${l}`),x=null);const t=x!==h?` F${h}`:"";y(`G0 X${i.toFixed(3)} Y${n.toFixed(3)}${t}`),x=h,y(`G1 Z${d}${x!==c?` F${c}`:""}`),x=c,s=!1,p=!1}else{const t=x!==h?` F${h}`:"";y(`G1 X${i.toFixed(3)} Y${n.toFixed(3)}${t}`),x=h}})}),y(`G0 Z${l}`),x=null,p=!0});let v,b=s;if(n<t.length-1){const e=t[n+1];b-=this.getKerningAdjustment(a,e)}if(void 0!==u.horizAdvX){const t=this.fontMetrics.ascent-this.fontMetrics.descent,e=.7*this.canvas.height/t;v=u.horizAdvX*e}else v=m.width;o+=v*g+b}const a=0===t.length?.5*e:m;M-=a}),f.push(""),y(`G0 Z${l} ; Return to safe Z`),y("G0 X0 Y0 ; Return to origin"),f.push("M2 ; End program"),this.generatedGCode=f.join("\n"),this.updateStatus("GCode generated!")}exportImage(){const t=document.getElementById("text-input").value;let e=parseFloat(document.getElementById("output-size").value);const s=parseFloat(document.getElementById("char-spacing").value),i=parseFloat(document.getElementById("space-width").value),n=parseFloat(document.getElementById("line-spacing").value),o=parseFloat(document.getElementById("max-width").value),a=parseFloat(document.getElementById("max-height").value),r=document.getElementById("auto-fit").checked;if(!t)return void alert("Please enter text to export");const h=this.canvas.height;let c=e/h,l=e+n;const d=this.fontMetrics.ascent-this.fontMetrics.descent,u=.7*this.canvas.height/d,g=t.split("\n");let m=[];if(o>0?g.forEach(t=>{const n=t.split(" ");let a="",r=0;n.forEach((t,n)=>{let h=0;for(let i=0;i<t.length;i++){const n=t[i],o=this.normalizeCharacter(n),a=this.font[o];h+=a?void 0!==a.horizAdvX?a.horizAdvX*u*c+s:a.bounds.width*c+s:.5*e+s}const l=this.font[" "],d=void 0!==l?.horizAdvX?l.horizAdvX*u*c+s:i+s;a.length>0&&r+d+h>o?(m.push(a),a=t,r=h):a.length>0?(a+=" "+t,r+=d+h):(a=t,r=h)}),m.push(a)}):m.push(...g),r&&(o>0||a>0)){const t=parseFloat(document.getElementById("max-text-size").value),r=t=>{const e=t/h,a=t+n,r=[];o>0?g.forEach(n=>{const a=n.split(" ");let h="",c=0;a.forEach(n=>{let a=0;for(let i=0;i<n.length;i++){const o=n[i],r=this.font[o];a+=r?r.bounds.width*e+s:.5*t+s}const l=i+s;h.length>0&&c+l+a>o?(r.push(h),h=n,c=a):h.length>0?(h+=" "+n,c+=l+a):(h=n,c=a)}),r.push(h)}):r.push(...g);let c=0;r.forEach(n=>{let o=0;for(let a=0;a<n.length;a++){const r=n[a],h=this.normalizeCharacter(r),c=this.font[h];if(c)o+=void 0!==c.horizAdvX?c.horizAdvX*e+s:c.bounds.width*e+s;else if(" "===r){const t=this.font[" "];o+=void 0!==t?.horizAdvX?t.horizAdvX*e+s:i+s}else o+=.5*t+s}c=Math.max(c,o)});let l=t;for(let e=1;e<r.length;e++)l+=0===r[e].length?.5*t:a;return{width:c,height:l,wrappedLines:r}};let d=e,u=m;for(let s=e;s<=t;s+=.5){const t=r(s),e=o<=0||t.width<=o,i=a<=0||t.height<=a;if(!e||!i)break;d=s,u=t.wrappedLines}e=d,m=u,c=e/h,l=e+n}let f=0;m.forEach(t=>{let n=0;for(let o=0;o<t.length;o++){const a=t[o],r=this.font[a];if(r)n+=void 0!==r.horizAdvX?r.horizAdvX*u*c+s:r.bounds.width*c+s;else if(" "===a){const t=this.font[" "];n+=void 0!==t?.horizAdvX?t.horizAdvX*u*c+s:i+s}else n+=.5*e+s}f=Math.max(f,n)});let p=e;for(let t=1;t<m.length;t++)p+=0===m[t].length?.5*e:l;const x=Math.ceil(f+40),y=Math.ceil(p+40),v=document.createElement("canvas");v.width=3*x,v.height=3*y;const b=v.getContext("2d");b.scale(3,3),b.fillStyle="#FFFFFF",b.fillRect(0,0,x,y),b.strokeStyle="#000000",b.lineWidth=.5,b.lineCap="round",b.lineJoin="round",b.imageSmoothingEnabled=!0,b.imageSmoothingQuality="high";let E=20;m.forEach(t=>{let n=20;for(let o=0;o<t.length;o++){const a=t[o],r=this.font[a];if(!r){n+=(" "===a?i:.5*e)+s;continue}const h=r.bounds;r.strokes.forEach(t=>{if(t.length<2)return;b.beginPath();const e=t[0],s=(e.x-h.minX)*c+n,i=e.y*c+E;b.moveTo(s,i);for(let e=1;e<t.length;e++){const s=(t[e].x-h.minX)*c+n,i=t[e].y*c+E;b.lineTo(s,i)}b.stroke()});const l=void 0!==r.horizAdvX?r.horizAdvX*u*c+s:h.width*c+s;n+=l}const o=0===t.length?.5*e:l;E+=o}),v.toBlob(t=>{const e=URL.createObjectURL(t),s=document.createElement("a");s.href=e;const i=document.getElementById("font-name").value.replace(/\s+/g,"_");s.download=`${i}_text.png`,s.click(),URL.revokeObjectURL(e)}),this.updateStatus("Image exported!")}exportSVG(){const t=document.getElementById("text-input").value;let e=parseFloat(document.getElementById("output-size").value);const s=parseFloat(document.getElementById("char-spacing").value),i=parseFloat(document.getElementById("space-width").value),n=parseFloat(document.getElementById("line-spacing").value),o=parseFloat(document.getElementById("max-width").value),a=parseFloat(document.getElementById("max-height").value),r=document.getElementById("auto-fit").checked;if(!t)return void alert("Please enter text to export");const h=this.canvas.height;let c=e/h;const l=this.fontMetrics.ascent-this.fontMetrics.descent,d=.7*this.canvas.height/l;let u=0;for(const t in this.font){const e=this.font[t];e&&e.bounds&&(u=Math.max(u,e.bounds.height))}0===u&&(u=h);let g=u*c,m=g+n;const f=t.split("\n");let p=[];if(o>0?f.forEach(t=>{const n=t.split(" ");let a="",r=0;n.forEach(t=>{let n=0;for(let i=0;i<t.length;i++){const o=t[i],a=this.font[o];n+=a?void 0!==a.horizAdvX?a.horizAdvX*d*c+s:a.bounds.width*c+s:.5*e+s}const h=this.font[" "],l=void 0!==h?.horizAdvX?h.horizAdvX*d*c+s:i+s;a.length>0&&r+l+n>o?(p.push(a),a=t,r=n):a.length>0?(a+=" "+t,r+=l+n):(a=t,r=n)}),p.push(a)}):p.push(...f),r&&(o>0||a>0)){const t=parseFloat(document.getElementById("max-text-size").value),r=t=>{const e=t/h,a=u*e+n,r=[];o>0?f.forEach(n=>{const a=n.split(" ");let h="",c=0;a.forEach(n=>{let a=0;for(let i=0;i<n.length;i++){const o=n[i],r=this.font[o];a+=r?r.bounds.width*e+s:.5*t+s}const l=i+s;h.length>0&&c+l+a>o?(r.push(h),h=n,c=a):h.length>0?(h+=" "+n,c+=l+a):(h=n,c=a)}),r.push(h)}):r.push(...f);let c=0;r.forEach(n=>{let o=0;for(let a=0;a<n.length;a++){const r=n[a],h=this.font[r];o+=h?h.bounds.width*e+s:(" "===r?i:.5*t)+s}c=Math.max(c,o)});let l=t;for(let e=1;e<r.length;e++)l+=0===r[e].length?.5*t:a;return{width:c,height:l,wrappedLines:r}};let l=e,d=p;for(let s=e;s<=t;s+=.5){const t=r(s),e=o<=0||t.width<=o,i=a<=0||t.height<=a;if(!e||!i)break;l=s,d=t.wrappedLines}e=l,p=d,c=e/h,g=u*c,m=g+n}let x=0;p.forEach(t=>{let n=0;for(let o=0;o<t.length;o++){const a=t[o],r=this.font[a];if(r)n+=void 0!==r.horizAdvX?r.horizAdvX*d*c+s:r.bounds.width*c+s;else if(" "===a){const t=this.font[" "];n+=void 0!==t?.horizAdvX?t.horizAdvX*d*c+s:i+s}else n+=.5*e+s}x=Math.max(x,n)}),g=u*c;let y=g;for(let t=1;t<p.length;t++)y+=0===p[t].length?.5*g:m;const v=x+40,b=y+40;let E='<?xml version="1.0" encoding="UTF-8"?>\n';E+=`<svg xmlns="http://www.w3.org/2000/svg" width="${4*v}" height="${4*b}" viewBox="0 0 ${v} ${b}">\n`,E+=' <rect width="100%" height="100%" fill="white"/>\n',E+=' <g stroke="black" stroke-width="0.3" stroke-linecap="round" stroke-linejoin="round" fill="none">\n';let C=20;p.forEach(t=>{let n=20;for(let o=0;o<t.length;o++){const a=t[o],r=this.normalizeCharacter(a),h=this.font[r];if(!h){n+=(" "===a?i:.5*e)+s;continue}const l=h.bounds;h.strokes.forEach(t=>{if(t.length<2)return;let e="";const s=t[0],i=(s.x-l.minX)*c+n,o=s.y*c+C;e+=`M ${i.toFixed(2)} ${o.toFixed(2)}`;for(let s=1;s<t.length;s++){const i=(t[s].x-l.minX)*c+n,o=t[s].y*c+C;e+=` L ${i.toFixed(2)} ${o.toFixed(2)}`}E+=` <path d="${e}"/>\n`});const u=void 0!==h.horizAdvX?h.horizAdvX*d*c+s:l.width*c+s;n+=u}const o=0===t.length?.5*e:m;C+=o}),E+=" </g>\n",E+="</svg>";const M=new Blob([E],{type:"image/svg+xml"}),I=URL.createObjectURL(M),S=document.createElement("a");S.href=I;const w=document.getElementById("font-name").value.replace(/\s+/g,"_");S.download=`${w}_text.svg`,S.click(),URL.revokeObjectURL(I),this.updateStatus("SVG exported!")}exportDXF(){const t=document.getElementById("text-input").value;let e=parseFloat(document.getElementById("output-size").value);const s=parseFloat(document.getElementById("char-spacing").value),i=parseFloat(document.getElementById("space-width").value),n=parseFloat(document.getElementById("line-spacing").value),o=parseFloat(document.getElementById("max-width").value),a=parseFloat(document.getElementById("max-height").value),r=document.getElementById("auto-fit").checked;if(!t)return void alert("Please enter text to export");const h=this.canvas.height;let c=e/h;const l=this.fontMetrics.ascent-this.fontMetrics.descent,d=.7*this.canvas.height/l;let u=0;for(const t in this.font){const e=this.font[t];e&&e.bounds&&(u=Math.max(u,e.bounds.height))}0===u&&(u=h);let g=u*c,m=g+n;const f=t.split("\n");let p=[];if(o>0?f.forEach(t=>{const n=t.split(" ");let a="",r=0;n.forEach(t=>{let n=0;for(let i=0;i<t.length;i++){const o=t[i],a=this.font[o];n+=a?void 0!==a.horizAdvX?a.horizAdvX*d*c+s:a.bounds.width*c+s:.5*e+s}const h=this.font[" "],l=void 0!==h?.horizAdvX?h.horizAdvX*d*c+s:i+s;a.length>0&&r+l+n>o?(p.push(a),a=t,r=n):a.length>0?(a+=" "+t,r+=l+n):(a=t,r=n)}),p.push(a)}):p.push(...f),r&&(o>0||a>0)){const t=parseFloat(document.getElementById("max-text-size").value),r=t=>{const e=t/h,a=t+n,r=[];o>0?f.forEach(n=>{const a=n.split(" ");let h="",c=0;a.forEach(n=>{let a=0;for(let i=0;i<n.length;i++){const o=n[i],r=this.font[o];a+=r?r.bounds.width*e+s:.5*t+s}const l=i+s;h.length>0&&c+l+a>o?(r.push(h),h=n,c=a):h.length>0?(h+=" "+n,c+=l+a):(h=n,c=a)}),r.push(h)}):r.push(...f);let c=0;r.forEach(n=>{let o=0;for(let a=0;a<n.length;a++){const r=n[a],h=this.font[r];o+=h?h.bounds.width*e+s:(" "===r?i:.5*t)+s}c=Math.max(c,o)});const l=u*e;let d=l;for(let t=1;t<r.length;t++)d+=0===r[t].length?.5*l:a;return{width:c,height:d,wrappedLines:r}};let l=e,d=p;for(let s=e;s<=t;s+=.5){const t=r(s),e=o<=0||t.width<=o,i=a<=0||t.height<=a;if(!e||!i)break;l=s,d=t.wrappedLines}e=l,p=d,c=e/h,g=u*c,m=g+n}g=u*c;let x=g;for(let t=1;t<p.length;t++)x+=0===p[t].length?.5*g:m;let y="";y+="0\nSECTION\n",y+="2\nHEADER\n",y+="9\n$INSUNITS\n70\n4\n",y+="0\nENDSEC\n",y+="0\nSECTION\n",y+="2\nENTITIES\n";let v=0,b=100;p.forEach(t=>{let n=0;for(let o=0;o<t.length;o++){const a=t[o],r=this.normalizeCharacter(a),h=this.font[r];if(!h){n+=(" "===a?i:.5*e)+s;continue}const l=h.bounds;h.strokes.forEach(t=>{t.length<2||(y+="0\nLWPOLYLINE\n",y+=`5\n${(b++).toString(16).toUpperCase()}\n`,y+="100\nAcDbEntity\n",y+="8\n0\n",y+="100\nAcDbPolyline\n",y+=`90\n${t.length}\n`,y+="70\n0\n",t.forEach(t=>{const e=(t.x-l.minX)*c+n,s=x-(t.y*c+v);y+=`10\n${e.toFixed(4)}\n`,y+=`20\n${s.toFixed(4)}\n`}))});const u=void 0!==h.horizAdvX?h.horizAdvX*d*c+s:l.width*c+s;n+=u}const o=0===t.length?.5*e:m;v+=o}),y+="0\nENDSEC\n",y+="0\nEOF\n";const E=new Blob([y],{type:"application/dxf"}),C=URL.createObjectURL(E),M=document.createElement("a");M.href=C;const I=document.getElementById("font-name").value.replace(/\s+/g,"_");M.download=`${I}_text.dxf`,M.click(),URL.revokeObjectURL(C),this.updateStatus("DXF exported!")}downloadGCode(){if(!this.generatedGCode)return void alert("Please generate GCode first");const t=new Blob([this.generatedGCode],{type:"text/plain"}),e=URL.createObjectURL(t),s=document.createElement("a");s.href=e,s.download="font_output.gcode",s.click(),URL.revokeObjectURL(e)}exportSVGFont(){if(0===Object.keys(this.font).length)return void alert("No characters in font. Please draw some characters first.");const t=document.getElementById("font-name").value||"CustomFont",e=t.replace(/\s+/g,"_").toLowerCase(),s=this.canvas.height,i=1e3/s;let n=0,o=0;for(const t in this.font){const e=this.font[t];e&&e.bounds&&(n+=e.bounds.width*i+100,o++)}const a=o>0?Math.round(n/o):500;let r='<?xml version="1.0" encoding="UTF-8"?>\n';r+='<svg xmlns="http://www.w3.org/2000/svg">\n',r+=" <defs>\n",r+=` <font id="${e}" horiz-adv-x="${a}">\n`,r+=` <font-face font-family="${t}" units-per-em="1000" ascent="800" descent="-200"/>\n`,r+=' <missing-glyph horiz-adv-x="500"/>\n';for(const t in this.font){const e=this.font[t];if(!e||!e.strokes||0===e.strokes.length)continue;const n=e.bounds,o=void 0!==e.horizAdvX?Math.round(e.horizAdvX):Math.round(n.width*i+100);let a="";e.strokes.forEach(t=>{if(t.length<2)return;const e=t[0],n=e.x*i,o=(s-e.y)*i;a+=`M ${n.toFixed(1)} ${o.toFixed(1)} `;for(let e=1;e<t.length;e++){const n=t[e].x*i,o=(s-t[e].y)*i;a+=`L ${n.toFixed(1)} ${o.toFixed(1)} `}});const h=t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;");r+=` <glyph unicode="${h}" horiz-adv-x="${o}" d="${a.trim()}"/>\n`}this.kerning.length>0&&this.kerning.forEach(t=>{const e=Math.round(t.k*i);if("unicode"===t.type){const s=this.escapeXML(t.u1),i=this.escapeXML(t.u2);r+=` <hkern u1="${s}" u2="${i}" k="${e}"/>\n`}else{const s=this.escapeXML(t.g1),i=this.escapeXML(t.g2);r+=` <hkern g1="${s}" g2="${i}" k="${e}"/>\n`}}),r+=" </font>\n",r+=" </defs>\n",r+="</svg>";const h=new Blob([r],{type:"image/svg+xml"}),c=URL.createObjectURL(h),l=document.createElement("a");l.href=c,l.download=`${t.replace(/\s+/g,"_")}.svg`,l.click(),URL.revokeObjectURL(c),this.updateStatus("SVG Font exported! Note: SVG fonts work in Safari, Inkscape, and Illustrator.")}escapeXML(t){return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")}toggleGuides(){this.showGuides=!this.showGuides,this.render()}updateGuidePosition(t,e){this.guidePositions[t]=e,this.render()}resetGuidePositions(){this.guidePositions={ascent:800,capHeight:700,xHeight:500,baseline:0,descent:-200},this.updateGuidePositionInputs(),this.render()}updateGuidePositionInputs(){document.getElementById("ascent-pos").value=this.guidePositions.ascent,document.getElementById("cap-height-pos").value=this.guidePositions.capHeight,document.getElementById("x-height-pos").value=this.guidePositions.xHeight,document.getElementById("baseline-pos").value=this.guidePositions.baseline,document.getElementById("descent-pos").value=this.guidePositions.descent}addKerning(){const t=document.getElementById("kerning-u1").value.trim(),e=document.getElementById("kerning-u2").value.trim(),s=document.getElementById("kerning-type").value,i=parseFloat(document.getElementById("kerning-value").value);if(!t||!e)return void alert("Please specify both first and second glyphs");if(isNaN(i))return void alert("Please enter a valid kerning adjustment value");const n={type:s,k:i};"unicode"===s?(n.u1=t,n.u2=e):(n.g1=t,n.g2=e),this.kerning.push(n),this.updateKerningList(),this.saveToLocalStorage(),document.getElementById("kerning-u1").value="",document.getElementById("kerning-u2").value=""}updateKerningList(){const t=document.getElementById("kerning-list");t.innerHTML="",Array.isArray(this.kerning)?this.kerning.forEach((e,s)=>{const i=document.createElement("div");i.style.cssText="display: flex; justify-content: space-between; align-items: center; padding: 5px; border-bottom: 1px solid var(--border-color);";const n="unicode"===e.type?e.u1:e.g1,o="unicode"===e.type?e.u2:e.g2,a="unicode"===e.type?"u":"g",r=e.k>0?"+":"",h=e.k>0?"closer":"apart";i.innerHTML=`\n <span style="flex: 1;"><strong>${n}</strong> + <strong>${o}</strong><em style="color: var(--secondary-color);">(${a})</em>: k=${r}${e.k} <em style="opacity: 0.7;">(${h})</em></span>\n <button onclick="fontCreatorController.removeKerning(${s})" style="padding: 2px 8px; font-size: 11px;">‚úñ</button>\n `,t.appendChild(i)}):this.kerning=[]}removeKerning(t){this.kerning.splice(t,1),delete this.kerning[pair],this.updateKerningList(),this.saveToLocalStorage()}updateStatus(t){const e=document.getElementById("status");e&&(e.textContent=t)}setupPanelToggle(){const t=document.getElementById("toggle-left-panel"),e=document.querySelector(".left-panel");t&&e&&t.addEventListener("click",()=>{e.classList.toggle("collapsed")})}}let fontCreatorController,previewController;async function loadGCodeIntoPreview(t){if(t&&previewController)try{await previewController.loadGCodeFromString(t)}catch(t){console.error("Error loading GCode into preview:",t)}}window.addEventListener("DOMContentLoaded",()=>{const t=localStorage.getItem("theme")||"light";document.documentElement.setAttribute("data-theme",t),fontCreatorController=new FontCreatorController,fontCreatorController.setupCanvas(),fontCreatorController.setupCharacterSet(),fontCreatorController.setupFontCreatorControls(),fontCreatorController.setupTextToGCodeControls(),fontCreatorController.setupPanelToggle(),fontCreatorController.loadFromLocalStorage(),fontCreatorController.render(),setTimeout(()=>{previewController=new Controller;const t=document.getElementById("download-gcode");t&&t.addEventListener("click",()=>{fontCreatorController&&fontCreatorController.downloadGCode&&fontCreatorController.downloadGCode()})},100),document.getElementById("theme-toggle").onclick=()=>{const t=document.documentElement,e=t.getAttribute("data-theme");t.setAttribute("data-theme","light"===e?"dark":"light"),localStorage.setItem("theme",t.getAttribute("data-theme")),fontCreatorController.render(),previewController&&previewController.is3DView?previewController.renderer3d.render():previewController&&previewController.renderer2d.render()}}),document.querySelectorAll(".tab-button").forEach(t=>{t.addEventListener("click",()=>{const e=t.dataset.tab;document.querySelectorAll(".tab-button").forEach(t=>t.classList.remove("active")),t.classList.add("active"),document.querySelectorAll(".tab-content").forEach(t=>t.classList.remove("active")),document.getElementById(e).classList.add("active"),"gcode-preview"===e&&fontCreatorController&&fontCreatorController.generatedGCode&&setTimeout(()=>{loadGCodeIntoPreview(fontCreatorController.generatedGCode)},50)})});</script></body></html>

